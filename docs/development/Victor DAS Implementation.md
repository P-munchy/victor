# Victor DAS Implementation

Created by David Mudie Last updated Oct 18, 2018

This page provides a summary of design and implementation decisions used to manage DAS event logs on Victor.

## DAS Data Specification

DAS field names and data types are determined by a shadowy cabal of power brokers, then implemented by the SAI team.

See DAS Protocol Changes for Victor and DAS Event Fields for Victor Robot for reference.

## DAS Event Declarations
DAS events should be declared and documented using the DASMSG macros described here:

https://github.com/anki/victor/blob/master/docs/development/das-events.md

You can view documentation generated by the last successful build here:

https://build.ankicore.com/viewLog.html?buildTypeId=Victor_Dev_DasDoxygenDocumentation&buildId=lastSuccessful

## Victor Log API
DAS event macros are expanded into calls on the Anki::Util::IEventProvider interface.

This interface is implemented by a utility class Anki::Util::VictorLogger.

VictorLogger formats each event into a CSV-like syntax that can be parsed efficiently by an aggregation service.

## Victor Log Format
VictorLogger marks each structured event record with '@'. This is used to identify log records that may contain structured DAS events.

Event fields are separated with a special character 0x1F, aka ASCII field separator.  This is a non-printing character that is reserved for this use on Victor. This character can't appear in DAS event data.

The separator (0x1F) may be displayed as empty space (logcat),  ^_ (emacs, vim), or omitted entirely (Android Studio).  There is no standard way to display non-printing characters so each application will make its own choice.

Each log record contains 9 or 10 fields (name, s1, s2, s3, s4, i1, i2, i3, i4, uptime_ms) at this time. Fields may be empty if they are not used.

The last field (uptime_ms) is optional. If present, it should be an int64 value indicating number of milliseconds since system boot.  If not present, it will be treated as a 0 and ingested as a null value.

The log record itself carries additional data such as source, event level, and timestamp.  These fields are not repeated in the text string.

## Victor Log Aggregation
Victor runs a log aggregation service called 'vic-dasmgr'.  This service attaches to the android log buffer and watches for log records marked with '@'.

Each log record marked with '@' is parsed as a structured event.  If a log record is successfully parsed as a DAS event, it is added to a queue of events. If a log record can't be parsed, it is reported as an error and discarded.

The aggregator adds some "global state" fields (robot ID, OS version, etc) to each event. This information is shared by all robot services and does not need to be duplicated in individual log records.

## Victor Log Upload
Incoming events are written to transient storage under /run/dasLogs. At regular intervals, transient log files are uploaded to an AWS SQS endpoint for ingestion.

At service shutdown, unsent log files are moved to persistent storage under /data/data/cache/com.anki.victor/cache/dasLogs. When service restarts, these log files are uploaded to an AWS SQS endpoint for ingestion.

Transient and persistent storage directories are subject to a configurable quota. 

## Global State
Some variables (e.g. profile_id) are saved to persistent storage in /data/data/com.anki.victor/persistent/dasGlobals.json. These variables are loaded at startup, saved at shutdown, and will persist across service restarts and system reboots. These variables are automatically cleared when system /data is wiped.

Some variables (e.g. sequence number) are saved to transient storage in /run/dasGlobals.json. These variables are loaded at startup, saved at shutdown, and will persist across service restarts but not system reboots. These variables are automatically cleared when the system reboots.

## Related Pages
DAS Protocol Changes for Victor

DAS Event Fields for Victor Robot
