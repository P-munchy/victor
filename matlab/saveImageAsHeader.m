
% function saveImageAsHeader(image, filename, imageName)

function saveImageAsHeader(image, filename, imageName)

image = im2uint8(image)';

fileId = fopen(filename, 'w');

curDate = date();

maxSlash = max([strfind(filename, '\'), strfind(filename, '/')]);
if isempty(maxSlash)
    maxSlash = 0;
end

maxDot = max(strfind(filename, '.'));
defineFilename = filename((maxSlash+1):(maxDot-1));

if ~exist('imageName', 'var')
    imageName = defineFilename;
end

% Swapped, because the input array is flipped
width = size(image,1);
height = size(image,2);

% These extended versions are for the myriad, which has weird issues
extendedWidth = 16*ceil(width/16) + 16;
extendedHeight = 16*ceil(height/16) + 16;

fprintf(fileId,...
    ['// Autogenerated by saveImageAsHeader.m on ', curDate([8:end,3,4:6,3,1:2]), '\n',...
    '\n',...
    '#ifndef _SAVEIMAGEASHEADER_', defineFilename, '_H_\n',...
    '#define _SAVEIMAGEASHEADER_', defineFilename, '_H_\n',...
    '\n',...
    '#include "anki/embeddedCommon/config.h\n\n',...
    '#define ', imageName, sprintf('_WIDTH %d\n',width),...
    '#define ', imageName, sprintf('_HEIGHT %d\n',height),...
    '#define ', imageName, '_NAME "', imageName, '"\n',...
    '\n',...
    '#if defined(USING_MOVIDIUS_COMPILER)\n',...
    '__attribute__((section(".imageData")))\n',...
    '#endif\n',...
    'const unsigned char ', imageName, sprintf('[%d] = {\n',extendedHeight*extendedWidth)]);

for y = 1:size(image,2)
    fprintf(fileId, '%d, ', image(:,y));
    fprintf(fileId, '\n');
end

fprintf(fileId,...
    ['};\n\n',...
     '#endif // _SAVEIMAGEASHEADER_', defineFilename, '_H_']);

fclose(fileId);