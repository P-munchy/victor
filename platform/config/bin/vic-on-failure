#!/bin/sh
#
# platform/config/bin/vic-on-failure
#
# Called by systemd when a service has exited with non-zero status.
# Default values may be overridden by service environment.
#
# When services are restarted, we create a magic file as a way of passing information to vic-anim.
# If vic-anim sees this file, it should display a custom restart animation.
# This file persists until it is removed by vic-anim or robot is rebooted.
#
set -u

# Do we want to run animfail?
: ${VIC_ONFAILURE_ANIMFAIL:="0"}

# Do we want to run systemctl restart?
: ${VIC_ONFAILURE_RESTART:="0"}

# What file do we create when restarting services?
: ${VIC_ONFAILURE_RESTART_FILE:="/tmp/vic-on-failure-restart"}

#
# Stop robot services?  Systemd doesn't recognize "kill victor.target"
# so we have to enumerate service names.
#
if [ "${VIC_ONFAILURE_RESTART}" == "1" ]; then
  echo "Stopping victor target"
  /bin/systemctl stop victor.target
  sleep 3
  echo "Killing victor services"
  /bin/systemctl kill vic-anim vic-cloud vic-crashuploader vic-dasmgr vic-engine vic-gateway vic-neuralnets vic-robot vic-switchboard vic-webserver
fi

#
# Display fault code?
#
if [ "${VIC_ONFAILURE_ANIMFAIL}" == "1" ]; then
  echo "Showing animation fault code"
  # Need to stop the early-anim (boot animation) first
  # should it be running
  /bin/systemctl stop early-anim
  /bin/animfail
fi

#
# Start robot services?
#
if [ "${VIC_ONFAILURE_RESTART}" == "1" ]; then
  echo "Touch ${VIC_ONFAILURE_RESTART_FILE}"
  /bin/touch ${VIC_ONFAILURE_RESTART_FILE}

  echo "Start victor target"
  /bin/systemctl start victor.target
fi
