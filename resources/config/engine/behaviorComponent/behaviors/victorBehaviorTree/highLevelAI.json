{
  "behaviorID" : "HighLevelAI",
  "behaviorClass" : "HighLevelAI",

  
  "socializeKnownFaceCooldown_s": 1800.0,
  "playWithCubeCooldown_s": 600.0,
  "playWithCubeOnChargerCooldown_s": 2400.0,
  "maxFaceDistanceToSocialize_mm": 1000.0,

  "initialState": "ObservingOnCharger",

  "resumeReplacements": {
    "NappingOnCharger" : "ObservingOnCharger",
    "Napping": "Observing"
  },
  // these are evaluated after resumeReplacements and override them
  "postBehaviorSuggestionResumeOverrides": {
    "Socialize": "Socializing",
    "PlayWithCube": "PlayingWithCube",
    "Nothing": "Observing",
    "Sleep": "Napping",
    "SleepOnCharger": "NappingOnCharger"
  },

  "states": [
    {
      "name": "ObservingOnCharger",
      "behavior": "ObservingOnCharger"
    },
    {
      "name": "ObservingOnChargerRecentlyPlaced",
      "behavior": "ObservingOnCharger",
      "getInBehavior": "ObservingOnChargerGetIn",
      "resetBehaviorTimer": "ObservingOnCharger"
    },
    {
      "name": "ObservingDriveOffCharger",
      "behavior": "ObservingDriveOffCharger",
      "getInBehavior": "ObservingOnChargerGetOut"
    },
    {
      "name": "DriveOffChargerIntoSocializing",
      "behavior": "DriveOffChargerIntoSocializing",
      "getInBehavior": "ObservingOnChargerGetOut"
    },    
    {
      "name": "Observing",
      "behavior": "Observing",
      "resetBehaviorTimer": "ObservingOffCharger"
    },
    {
      "name": "Exploring",
      "behavior": "Exploring",
      "getInBehavior": "ExploringGetIn"
    },
    {
      "name": "ExploringVoiceCommand",
      "behavior": "ExploringVoiceCommand",
      "getInBehavior": "ExploringGetIn",
      "activateIntent": "explore_start"
    },
    {
      "name": "InvestigateHeldCube",
      "behavior": "InvestigateHeldCube",
      "getInBehavior": "InvestigateHeldCubeGetIn"
    },
    {
      "name": "Socializing",
      "behavior": "Socialize"
    },
    {
      "name": "PlayingWithCube",
      "behavior": "PlayWithCube"
    },
    {
      "name": "Napping",
      "behavior": "Sleeping",
      "activateIntent": "system_sleep"
    },
    {
      "name": "NappingOnCharger",
      "behavior": "Sleeping",
      "activateIntent": "system_sleep"
    },
    {
      "name": "WakingUp",
      "behavior": "SleepingWakeUp"
    },
    {
      "name": "WakingUpLights",
      "behavior": "SleepingWakeUpLights"
    },
    {
      "name": "ReturningToCharger",
      "behavior": "FindAndGoToHome",
      "activateIntent": "system_charger"
    },
    {
      "name": "FailedToFindCharger",
      "behavior": "ObservingFailedToFindCharger"
    }
  ],

  "stateTimerConditions": [
    {
      "name": "BoredOfObserving",
      "begin_s": 1100.0
    },
    {
      "name": "BoredOfExploring",
      "begin_s": 600.0
    },
    {
      "name": "NoLongerRecentlyPlaced",
      "begin_s": 150.0
    },
    {
      "name": "WakeUpFromNap",
      "begin_s": 14400.0
    },
    {
      "name": "NapHasBeenLong",
      "begin_s": 10800.0
    },
    {
      "name": "FailedToFindCharger",
      "begin_s": 300.0
    }
  ],

  "transitionDefinitions": [
    {
      // TODO:(bn) split this up into multiple files?
      
      "from": "ObservingOnCharger",
      "interruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "Compound",
            "not": {
              "conditionType": "OnChargerPlatform"
            }
          }
        },
        {
          "to": "DriveOffChargerIntoSocializing",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "CloseFaceForSocializing"
              },
              {
                "conditionType": "Emotion",
                "emotion": "Stimulated",
                "min": 0.7
              }
            ]
          }
        },
        {
          "to": "InvestigateHeldCube",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "UserIsHoldingCube"
              },
              {
                "conditionType": "ObjectKnown",
                "objectTypes": ["Block_LIGHTCUBE1","Block_LIGHTCUBE2","Block_LIGHTCUBE3"],
                "maxAge_ms" : 1000
              },
              {
                "conditionType": "FeatureGate",
                "feature": "CubeBehaviors"
              }
            ]
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "ObservingDriveOffCharger",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "BoredOfObserving"
              },
              {
                "conditionType": "SimpleMood",
                "mood": "HighStim"
              }
            ]
          }
        },
        {
          "to": "ObservingDriveOffCharger",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "WantsToLeaveChargerForPlay"
              },
              {
                "conditionType": "SimpleMood",
                "mood": "HighStim"
              }
            ]
          }
        },
        {
          "to": "NappingOnCharger",
          "condition": {
            "conditionType": "SimpleMood",
            "to": "LowStim"
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "Compound" ,
            "not": {
              "conditionType": "OnCharger"
            }
          }
        }
      ]
    },

    {
      "from": "ObservingOnChargerRecentlyPlaced",

      "interruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "Compound",
            "not": {
              "conditionType": "OnChargerPlatform"
            }
          }
        },
        {
          "to": "InvestigateHeldCube",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "UserIsHoldingCube"
              },
              {
                "conditionType": "ObjectKnown",
                "objectTypes": ["Block_LIGHTCUBE1","Block_LIGHTCUBE2","Block_LIGHTCUBE3"],
                "maxAge_ms" : 1000
              },
              {
                "conditionType": "FeatureGate",
                "feature": "CubeBehaviors"
              }
            ]
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "ObservingOnCharger",
          "condition": {
            "customCondition": "NoLongerRecentlyPlaced"
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "Compound",
            "not": {
              "conditionType": "OnCharger"
            }
          }
        }
      ]
    },

    {
      "from": [
        "Observing",
        "Socializing",
        "DriveOffChargerIntoSocializing",
        "PlayingWithCube",
        "Exploring",
        "ExploringVoiceCommand",
        "InvestigateHeldCube"
      ],
      "interruptingTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "BecameTrueThisTick",
            "subCondition": {
              "conditionType": "OnCharger"
            }
          },
          "emotionEvent": "PlacedOnCharger"
        }
      ]
    },

    {
      "from": "Observing",
      "interruptingTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "CloseFaceForSocializing"
              },
              {
                "conditionType": "Emotion",
                "emotion": "Stimulated",
                "min": 0.5
              }
            ]
          }
        },
        {
          "to": "PlayingWithCube",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "CloseCubeForPlaying"
              },
              {
                "conditionType": "SimpleMood",
                "mood": "HighStim"
              },
              {
                "conditionType": "Compound",
                "not": { "conditionType": "RobotInHabitat" }
              }
            ]
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "Exploring",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "FeatureGate",
                "feature": "Exploring" 
              },
              {
                "conditionType": "SimpleMood",
                "from": "HighStim",
                "to": "MedStim"
              },
              {
                "conditionType": "ObjectKnown",
                "objectTypes": ["Charger_Basic"]
              },
              {
                "conditionType": "Compound",
                "not": { "conditionType": "RobotInHabitat" }
              }
            ]
          }
        },
        {
          "to": "Napping",
          "condition": {
            "conditionType": "SimpleMood",
            "to": "LowStim"
          }
        }
      ]
    },

    {
      "from": "Exploring",
      "interruptingTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "CloseFaceForSocializing"
              },
              {
                "conditionType": "Emotion",
                "emotion": "Stimulated",
                "min": 0.7
              }
            ]
          }
        },
        {
          // recently put down (we can't consider picked up since an interruption handles that)
          "to": "Observing",
          "condition": {
            "conditionType": "OffTreadsState",
            "targetState": "OnTreads",
            "maxTimeSinceChange_ms": 3100 // fragile: the put down behavior lasts 3000.
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "Observing",
          "condition":
          {
            "conditionType": "SimpleMood",
            "from": "MedStim",
            "to": "LowStim"
          }
        }
      ]
    },

    {
      "from": [
        "ExploringVoiceCommand", 
        "Exploring" // stimulation decay should happen before this, but just in case it's continually stimulated while exploring
      ],
      "nonInterruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "customCondition": "BoredOfExploring"
          }
        }
      ]
    },

    {
      "from": [
        "Observing",
        "Socializing",
        "PlayingWithCube",
        "Exploring",
        "ExploringVoiceCommand"
      ],
      "interruptingTransitions": [
        {
          "to": "InvestigateHeldCube",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "UserIsHoldingCube"
              },
              {
                "conditionType": "ObjectKnown",
                "objectTypes": ["Block_LIGHTCUBE1","Block_LIGHTCUBE2","Block_LIGHTCUBE3"],
                "maxAge_ms" : 1000
              },
              {
                "conditionType": "FeatureGate",
                "feature": "CubeBehaviors"
              }
            ]
          }
        }
      ]
    },
    
    {
      "from": [
        "Socializing",
        "PlayingWithCube",
        "Exploring",
        "ExploringVoiceCommand",
        "InvestigateHeldCube"
      ],
      "exitTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },

    {
      "from": "ObservingDriveOffCharger",
      "exitTransitions": [
        {
          // even though we weren't planning to socialize, if we can now then we should (socializing is important)
          "to": "Socializing",
          "condition": {
            "customCondition": "CloseFaceForSocializing"
          }
        },
        {
          "to": "PlayingWithCube",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "customCondition": "CloseCubeForPlaying"
              },
              {
                // NOTE: it's possible that stim dropped during the driving off of the charger, in this case we'll
                // fall back to observing but any additional stim should quickly get us back into playing range
                "conditionType": "SimpleMood",
                "mood": "HighStim"
              },
              {
                "conditionType": "Compound",
                "not": { "conditionType": "RobotInHabitat" }
              }
            ]
          }
        },
        {
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "DriveOffChargerIntoSocializing",
      "exitTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },
    
    {
      "from": "NappingOnCharger",
      "interruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "Compound",
            "or": [
              {
                "conditionType": "TriggerWordPending"
              },
              {
                "conditionType": "Compound",
                "not": {
                  "conditionType": "OnCharger"
                }
              },
              {
                "customCondition": "WakeUpFromNap"
              },
              {
                "conditionType": "Compound",
                "and": [
                  {
                    "conditionType": "UserIntentActive",
                    "list": [
                      {"type": "system_sleep"}
                    ]
                  },
                  {
                    "conditionType": "AnyStimuli",
                    "MotionDetected": false,
                    "FacePositionUpdated": false,
                    "FaceKnown": false,
                    "RobotTouched": true,
                    "RobotShaken": true
                  }
                ]
              },
              {
                "conditionType": "Compound",
                "and": [
                  {
                    "conditionType": "AnyStimuli",
                    "MotionDetected": true,
                    "FacePositionUpdated": false,
                    "FaceKnown": false,
                    "RobotTouched": true,
                    "RobotShaken": true
                  },
                  {
                    "customCondition": "NapHasBeenLong"
                  }
                ]
              }
            ]
          }
        },
        {
          "to": "WakingUpLights",
          "condition": {
            "conditionType": "IlluminationDetected",
            "triggerStates": ["Illuminated"],
            "confirmationTime": 1.0,
            "confirmationMinNum": 3,
            "ignoreUnknown": false
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "Compound",
                "or": [
                  {
                    "conditionType": "SimpleMood",
                    "mood": "MedStim"
                  },
                  {
                    "conditionType": "SimpleMood",
                    "mood": "HighStim"
                  },
                  {
                    "conditionType": "AnyStimuli",
                    "MotionDetected": false,
                    "FacePositionUpdated": false,
                    "FaceKnown": false,
                    "RobotTouched": true,
                    "RobotShaken": true
                  }
                ]
              },
              {
                "conditionType": "Compound",
                "not": {
                  "conditionType": "UserIntentActive",
                  "list": [
                    {"type": "system_sleep"}
                  ]
                }
              }
            ]
          }
        }
      ]
    },

    {
      "from": "Napping",
      "interruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "Compound",
            "or": [
              {
                "conditionType": "TriggerWordPending"
              },
              {
                "conditionType": "OnCharger"
              },
              {
                "customCondition": "WakeUpFromNap"
              },
              {
                "conditionType": "Compound",
                "and": [
                  {
                    "conditionType": "UserIntentActive",
                    "list": [
                      {"type": "system_sleep"}
                    ]
                  },
                  {
                    "conditionType": "AnyStimuli",
                    "MotionDetected": false,
                    "FacePositionUpdated": false,
                    "FaceKnown": false,
                    "RobotTouched": true,
                    "RobotShaken": true
                  }
                ]
              },
              {
                "conditionType": "Compound",
                "and": [
                  {
                    "conditionType": "AnyStimuli",
                    "MotionDetected": true,
                    "FacePositionUpdated": false,
                    "FaceKnown": false,
                    "RobotTouched": true,
                    "RobotShaken": true
                  },
                  {
                    "customCondition": "NapHasBeenLong"
                  }
                ]
              }
            ]
          }
        },
        {
          "to": "WakingUpLights",
          "condition": {
            "conditionType": "IlluminationDetected",
            "triggerStates": ["Illuminated"],
            "confirmationTime": 1.0,
            "confirmationMinNum": 3,
            "ignoreUnknown": false
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "Compound",
                "or": [
                  {
                    "conditionType": "SimpleMood",
                    "mood": "MedStim"
                  },
                  {
                    "conditionType": "SimpleMood",
                    "mood": "HighStim"
                  },
                  {
                    "conditionType": "AnyStimuli",
                    "MotionDetected": false,
                    "FacePositionUpdated": false,
                    "FaceKnown": false,
                    "RobotTouched": true,
                    "RobotShaken": true
                  }
                ]
              },
              {
                "conditionType": "Compound",
                "not": {
                  "conditionType": "UserIntentActive",
                  "list": [
                    {"type": "system_sleep"}
                  ]
                }
              }
            ]
          }
        }
      ]
    },

    {
      "from": "WakingUp",
      "exitTransitions": [
        {
          "to": "ObservingOnCharger",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },
    
    // Sad to need all this duplication for WakingUp and WakingUpLights, but current design
    // is such that Sleeping doesn't know _why_ it ended (only High Level AI does), so we
    // need two different high level behaviors to transition to/from in order to get a
    // different animation when interrupted by the lights coming on.
    {
      "from": "WakingUpLights",
      "exitTransitions": [
        {
          "to": "ObservingOnCharger",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "ReturningToCharger",
      "interruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "OffTreadsState",
            "targetState": "InAir"
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "FailedToFindCharger",
          "condition": {
            "customCondition": "FailedToFindCharger"
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          }
        }
      ]
    },

    {
      "from": "FailedToFindCharger",
      "interruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "condition": {
            "customCondition": "ChargerLocated"
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          },
          "emotionEvent": "PlacedOnCharger"
        },
        {
          "to": "Napping",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },

    //***************************
    // VOICE COMMANDS   
    //*************************** 

    // go to your charger
    {
      "from": [
        "ObservingDriveOffCharger",
        "DriveOffChargerIntoSocializing",
        "Observing",
        "ReturningToCharger", // to avoid unclaimed intent
        "Socializing",
        "Exploring",
        "ExploringVoiceCommand",
        "FailedToFindCharger",
        "InvestigateHeldCube"
      ],
      "interruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_charger"}
            ]
          }
        }
      ]
    },
    {
      "from": [
        "PlayingWithCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_charger"}
            ]
          }
        }
      ]
    },

    // go to sleep
    {
      "from": [
        "ObservingDriveOffCharger",
        "DriveOffChargerIntoSocializing",
        "Observing",
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "Socializing",
        "WakingUp",
        "WakingUpLights",
        "ReturningToCharger",
        "FailedToFindCharger",
        "PlayingWithCube",
        "Exploring",
        "ExploringVoiceCommand",
        "InvestigateHeldCube"
      ],
      "interruptingTransitions": [
        {
          "to": "Napping",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "UserIntentPending",
                "list": [
                  {"type": "system_sleep"}
                ]
              },
              {
                "conditionType": "Compound",
                "not": {
                  "conditionType": "OnCharger"
                }
              }
            ]
          }
        },
        {
          "to": "NappingOnCharger",
          "condition": {
            "conditionType": "Compound",
            "and": [
              {
                "conditionType": "UserIntentPending",
                "list": [
                  {"type": "system_sleep"}
                ]
              },
              {
                "conditionType": "OnCharger"
              }
            ]
          }
        }
      ]
    },
    {
      "from": [
        "PlayingWithCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "Napping",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_sleep"}
            ]
          }
        }
      ]
    },

    // explore voice command
    {
      "from": [
        "DriveOffChargerIntoSocializing",
        "ObservingDriveOffCharger",
        "Observing",
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "Socializing",
        "WakingUp",
        "WakingUpLights",
        "ReturningToCharger",
        "FailedToFindCharger",
        "PlayingWithCube",
        "Exploring",
        "ExploringVoiceCommand",
        "InvestigateHeldCube"
      ],
      "interruptingTransitions": [
        {
          "to": "ExploringVoiceCommand",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "explore_start"}
            ]
          }
        }
      ]
    }

  ]

}
