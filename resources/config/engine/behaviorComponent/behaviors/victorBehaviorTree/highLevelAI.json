{
  "behaviorID" : "HighLevelAI",
  "behaviorClass" : "HighLevelAI",

  
  "socializeKnownFaceCooldown_s": 1800.0,
  "playWithCubeCooldown_s": 600.0,
  "playWithCubeOnChargerCooldown_s": 2400.0,
  "goToSleepTimeout_s": 1200.0,
  "minFaceTimeToAllowSleep_s": 600.0,
  "maxFaceDistanceToSocialize_mm": 500.0,

  "initialState": "ObservingOnCharger",

  "resumeReplacements": {
    "Napping" : "ObservingOnCharger"
  },

  "states": [
    {
      "name": "ObservingOnCharger",
      "behavior": "ObservingOnCharger",
      "debugColor": "ORANGE"
    },
    {
      "name": "ObservingOnChargerRecentlyPlaced",
      "behavior": "ObservingOnCharger",
      "debugColor": "RED"
    },
    {
      "name": "DriveOffChargerIntoObserving",
      "behavior": "DriveOffChargerIntoObserving"
    },
    {
      "name": "DriveOffChargerIntoSocializing",
      "behavior": "DriveOffChargerIntoSocializing"
    },
    {
      "name": "DriveOffChargerIntoPlay",
      "behavior": "DriveOffChargerIntoPlay"
    },
    {
      "name": "Observing",
      "behavior": "Observing",
      "debugColor": "BLUE"
    },
    {
      "name": "Socializing",
      "behavior": "Socialize",
      "debugColor": "MAGENTA"
    },
    {
      "name": "PlayingWithCube",
      "behavior": "PlayWithCube",
      "debugColor": "DARKGREEN"
    },
    {
      "name": "RollCube",
      "behavior": "RollCubeVoiceCommand",
      "clearIntent": "play_specific"
    },
    {
      "name": "Napping",
      "behavior": "Sleeping",
      "debugColor": "GREEN",
      "clearIntent": "system_sleep"
    },
    {
      "name": "NappingOnCharger",
      "behavior": "Sleeping",
      "debugColor": "GREEN",
      "clearIntent": "system_sleep"
    },
    {
      "name": "WakingUp",
      "behavior": "SleepingWakeUp"
    },
    {
      "name": "ReturningToCharger",
      "behavior": "FindAndGoToHome",
      "debugColor": "WHITE",
      "clearIntent": "system_charger"
    },
    {
      "name": "FailedToFindCharger",
      "behavior": "ObservingFailedToFindCharger"
    },
    {
      "name": "FistBump",
      "behavior": "FistBumpVoiceCommand",
      "debugColor": "WHITE",
      "clearIntent": "play_specific"
    },
    {
      "name": "ComeHere",
      "behavior": "ComeHereVoiceCommand",
      "clearIntent": "imperative_come"
    },
    {
      "name": "Keepaway",
      "behavior": "KeepawayVoiceCommand",
      "debugColor": "YELLOW",
      "clearIntent": "play_specific"
    },
    {
      "name": "ReactToCubeTap",
      "behavior": "ReactToCubeTap",
      "debugColor": "WHITE"
    }
  ],

  "transitionDefinitions": [
    {
      // TODO:(bn) split this up into multiple files?
      
      "from": "ObservingOnCharger",
      "interruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "Negate",
            "operand": {
              "conditionType": "OnCharger"
            }
          }
        },        
        {
          "to": "DriveOffChargerIntoSocializing",
          "preDefinedStrategyName": "CloseFaceForSocializing"
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "DriveOffChargerIntoObserving",
          "condition": {
            "conditionType": "TimerInRange",
            "begin_s": 1100.0,
            "manualResetOnly": true
          }
        },
        {
          "to": "DriveOffChargerIntoPlay",
          "preDefinedStrategyName": "NeedsToLeaveChargerForPlay"
        },
        {
          "to": "NappingOnCharger",
          "preDefinedStrategyName": "WantsToSleep"
        }
      ]
    },

    {
      "from": "ObservingOnChargerRecentlyPlaced",

      "interruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "Negate",
            "operand": {
              "conditionType": "OnCharger"
            }
          }
        }
      ],
      "nonInterruptingTransitions": [        
        {
          "to": "ObservingOnCharger",
          "condition": {
            "conditionType": "TimerInRange",
            "begin_s": 1200.0,
            "manualResetOnly": true
          }
        }
      ]
    },

    {
      "from": "Observing",
      "interruptingTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          }
        },
        {
          "to": "Socializing",
          "preDefinedStrategyName": "CloseFaceForSocializing"
        },
        {
          "to": "PlayingWithCube",
          "preDefinedStrategyName": "CloseCubeForPlaying"
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "condition": {
            "conditionType": "BatteryLevel",
            "targetBatteryLevel": "Low"
          }
        }
      ]
    },

    {
      "from": "Socializing",
      "interruptingTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },

    {
      "from": "PlayingWithCube",
      "interruptingTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },

    {
      "from": "DriveOffChargerIntoObserving",
      "exitTransitions": [
        {
          "to": "Socializing",
          "preDefinedStrategyName": "CloseFaceForSocializing"
        },
        {
          // fall back to observing if can't find a face after driving off the charger
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "DriveOffChargerIntoPlay",
      "exitTransitions": [
        {
          "to": "PlayingWithCube",
          "preDefinedStrategyName": "CloseCubeForPlaying"
        },
        {
          // fall back to observing if can't find a cube after driving off the charger
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "DriveOffChargerIntoSocializing",
      "exitTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },
    
    {
      "from": "NappingOnCharger",
      "interruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "Negate",
            "operand": {
              "conditionType": "OnCharger"
            }
          }
        },
        {
          "to": "ObservingOnCharger",
          "condition": {
            "conditionType": "TriggerWordPending"
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "TimerInRange",
            "begin_s": 14400.0,
            "manualResetOnly": true
          }
        }
      ]
    },

    {
      "from": "Napping",
      "interruptingTransitions": [
        {
          "to": "WakingUp",
          "condition": {
            "conditionType": "OnCharger"
          }
        }
      ]
    },

    {
      "from": "WakingUp",
      "exitTransitions": [
        {
          "to": "ObservingOnCharger",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },

    {
      "from": "ReturningToCharger",
      "interruptingTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "OffTreadsState",
            "targetState": "InAir"
          }
        }
      ],
      "nonInterruptingTransitions": [
        {
          "to": "FailedToFindCharger",
          "condition": {
            "conditionType": "TimerInRange",
            "begin_s": 300.0,
            "manualResetOnly": true
          }
        }
      ],
      "exitTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          }
        }
      ]
    },

    {
      "from": "FailedToFindCharger",
      "interruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "preDefinedStrategyName": "ChargerLocated"
        }
      ],
      "exitTransitions": [
        {
          "to": "ObservingOnChargerRecentlyPlaced",
          "condition": {
            "conditionType": "OnCharger"
          }
        },
        {
          "to": "Napping",
          "condition": {
            "conditionType": "TrueCondition" 
          }
        }
      ]
    },

    {
      "from": "FistBump",
      "exitTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "ComeHere",
      "exitTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "Keepaway",
      "exitTransitions": [
        {
          "to": "Socializing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "RollCube",
      "exitTransitions": [
        {
          "to": "Observing",
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    {
      "from": "ReactToCubeTap",
      "exitTransitions": [
        {
          "to": "PlayingWithCube", // play with the cube after you were called to a cube
          "condition": {
            "conditionType": "TrueCondition"
          }
        }
      ]
    },

    //***************************
    // VOICE COMMANDS   
    //*************************** 

    // go to your charger
    {
      "from": [
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "FistBump",
        "ComeHere",
        "Keepaway",
        "Observing",
        "ReturningToCharger", // to avoid unclaimed intent
        "Socializing",
        "RollCube",
        "Keepaway",
        "ReactToCubeTap"
      ],
      "interruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_charger"}
            ]
          }
        }
      ]
    },
    {
      "from": [
        "PlayingWithCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "ReturningToCharger",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_charger"}
            ]
          }
        }
      ]
    },

    // do a fist bump
    {
      "from": [
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "FistBump",
        "ComeHere",
        "Keepaway",
        "Observing",
        "Socializing",
        "WakingUp",
        "ReturningToCharger",
        "FailedToFindCharger",
        "ReactToCubeTap"
      ],
      "interruptingTransitions": [
        {
          "to": "FistBump",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "play_specific",
                "entity_behavior": "fist_bump"
              }
            ]
          }
        }
      ]
    },
    {
      "from": [
        "PlayingWithCube",
        "RollCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "FistBump",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "play_specific",
                "entity_behavior": "fist_bump"
              }
            ]
          }
        }
      ]
    },

    // Play Keepaway
    {
      "from": [
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "FistBump",
        "ComeHere",
        "Keepaway",
        "Observing",
        "Socializing",
        "WakingUp",
        "ReturningToCharger",
        "FailedToFindCharger",
        "ReactToCubeTap"
      ],
      "interruptingTransitions": [
        {
          "to": "Keepaway",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "play_specific",
                "entity_behavior": "keep_away"
              }
            ]
          }
        }
      ]

    },
    {
      "from": [
        "PlayingWithCube",
        "RollCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "Keepaway",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "play_specific",
                "entity_behavior": "keep_away"
              }
            ]
          }
        }
      ]
    },

    // go to sleep off charger
    {
      "from": [
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "FistBump",
        "ComeHere",
        "Keepaway",
        "Observing",
        "Socializing",
        "WakingUp",
        "ReturningToCharger",
        "FailedToFindCharger",
        "PlayingWithCube",
        "RollCube",
        "ReactToCubeTap"
      ],
      "interruptingTransitions": [
        {
          "to": "Napping",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_sleep"}
            ]
          }
        }
      ]
    },
    {
      "from": [
        "PlayingWithCube",
        "RollCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "Napping",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_sleep"}
            ]
          }
        }
      ]
    },

    // go to sleep on charger
    {
      "from": [
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced"
      ],
      "interruptingTransitions": [
        {
          "to": "NappingOnCharger",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {"type": "system_sleep"}
            ]
          }
        }
      ]
    },

    // roll cube
    {
      "from": [
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "ComeHere",
        "Observing",
        "Socializing",
        "WakingUp",
        "ReturningToCharger",
        "FailedToFindCharger",
        "PlayingWithCube",
        "RollCube",
        "ReactToCubeTap"
      ],
      "interruptingTransitions": [
        {
          "to": "RollCube",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "play_specific",
                "entity_behavior": "roll_cube"
              }
            ]
          }
        }
      ]
    },
    {
      "from": [
        "FistBump",
        "Keepaway"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "RollCube",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "play_specific",
                "entity_behavior": "roll_cube"
              }
            ]
          }
        }
      ]

    },

    // come here
    {
      "from": [
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "FistBump",
        "ComeHere",
        "Keepaway",
        "Observing",
        "Socializing",
        "WakingUp",
        "ReturningToCharger",
        "FailedToFindCharger"
      ],
      "interruptingTransitions": [
        {
          "to": "ComeHere",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "imperative_come"
              }
            ]
          }
        }
      ]
    },
    {
      "from": [
        "PlayingWithCube",
        "RollCube"
      ],
      "nonInterruptingTransitions": [
        {
          "to": "ComeHere",
          "condition": {
            "conditionType": "UserIntentPending",
            "list": [
              {
                "type": "imperative_come"
              }
            ]
          }
        }
      ]
    },

    //***************************
    // USER INTERACTION COMMANDS
    //***************************

    {
      "from": [
        "ObservingOnCharger",
        "ObservingOnChargerRecentlyPlaced",
        "DriveOffChargerIntoObserving",
        "DriveOffChargerIntoSocializing",
        "DriveOffChargerIntoPlay",
        "FistBump",
        "ComeHere",
        "Observing",
        "Socializing",
        "WakingUp",
        "ReturningToCharger",
        "FailedToFindCharger"
      ],
      "interruptingTransitions": [
        {
          "to": "ReactToCubeTap",
          "condition": {
            "conditionType": "CubeTapped"
          }
        }
      ]
    }
  ]

}
