<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>OverDrive Vehicle Control</title>

  <!-- jQuery 3.2.1, MIT license: https://jquery.org/license/ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> 
  <!-- CodeMirror 5.25.2 MIT License: http://codemirror.net/LICENSE -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.2/mode/lua/lua.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.2/theme/blackboard.min.css">

  <style type="text/css">
    html, body {
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial;
    }

    #right{
      float: right;
      position: absolute;
      top:10px;
      bottom: 20px;
      right: 0;
      width:40%;
    }

    #left{
      width:60%;
      float: left;
      position: absolute;
      top:10px;
      bottom: 20px;
      overflow-y: hidden;
      display: flex;
    }

    #footer{
      background-color:darkgrey;
      width:100%;
      height: 20px;
      bottom:0;
      position:absolute;
      font-size:10px;
      line-height: 20px;
      vertical-align: middle;
      padding-left:5px;
    }

    #header{
      background-color:darkgrey;
      width:100%;
      height:10px;
    }

    #inputContainer, 
    #outputContainer {
      flex: 1;
      height:100%;
      background:darkgray;
      overflow-x:hidden;
      display:flex;
      flex-direction: column;
    }

    #draggablebar {
      background-color:darkgrey;
      height:100%;
      flex: 0 0 3px;
      cursor: col-resize;
      z-index:100;
    }

    #toolbar {
      width:100%;
      padding-left: 10px;
      background-color:darkgrey;
      flex: 0 0 30px;
    }

    .toolbarItem {
      margin-right: 10px;
      display:inline-block;
      width: auto;
      vertical-align: middle;
      line-height: 16px
    }

    #inputField {
      width: 100%;
      height: 100%;
      background: white;
      border:1px solid red;
      resize: none;
      flex: 1;
    }

    .btn {
      -webkit-border-radius: 3;
      -moz-border-radius: 3;
      border-radius: 3px;
      font-family: Arial;
      color: black;
      font-size: 14px;
      background: lightgrey;
      padding: 5px 10px 5px 10px;
      text-decoration: none;
      width:auto;
      min-width:10px;
      cursor:pointer;
    }
    .btn:active {
      background: #3aa1e6;
      text-decoration: none;
    }

    #btnHelp {
      -webkit-border-radius: 14;
      -moz-border-radius: 14;
      border-radius: 14px;
      min-width: inherit;
    }
    
    #btnPlay,
    #btnStop {
      min-width: inherit;
    }
    
    .CodeMirror {
      line-height:18px;
    }
    .CodeMirror-gutters {
      border-right: 1px solid #ddd ! important;
    }

    #right .CodeMirror {
      background:black;
      color:white;
    }
    .btn.disabled {
      text-decoration: none;
      background: #808080;
      color: #A0A0A0;
      cursor: default;
    }
    #btnClear {
      float: right;
    }
    #scriptsList {
      font-size:14px;
      height:20px;
      min-width:200px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      -webkit-animation-name: fadeIn;
      -webkit-animation-duration: 0.4s;
      animation-name: fadeIn;
      animation-duration: 0.4s
    }

    
    .modal-content {
      position: fixed;
      bottom: 0;
      background-color: #fefefe;
      width: 100%;
      -webkit-animation-name: slideIn;
      -webkit-animation-duration: 0.4s;
      animation-name: slideIn;
      animation-duration: 0.4s
    }

    .close {
      color: white;
      float: right;
      font-size: 28px;
      line-height:20px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .modal-header {
      padding: 2px 5px;
      background-color:darkgrey;
      color: white;
    }

    .modal-body {
      padding: 10px 5px;
      font-size:12px;
      display: flex;
    }

    .modal-section {
      padding-left:10px;
      padding-right:30px;
      border-right:1px solid #EEEEEE;
      max-height:300px;
      overflow-y:scroll;
    }

    .modal-section ul {
      list-style-type:none;
    }

    .modal-section ul li {
      padding-left: 18px;
      text-indent: -18px;
      margin: 0 0 3px 0;
    }

    .div-link {
      border-bottom: 1px dotted #555;
      text-decoration: none;
      cursor:pointer;
    }
    
    @-webkit-keyframes slideIn {
      from {bottom: -300px; opacity: 0} 
      to {bottom: 0; opacity: 1}
    }

    @keyframes slideIn {
      from {bottom: -300px; opacity: 0}
      to {bottom: 0; opacity: 1}
    }

    @-webkit-keyframes fadeIn {
      from {opacity: 0} 
      to {opacity: 1}
    }

    @keyframes fadeIn {
      from {opacity: 0} 
      to {opacity: 1}
    }

    ul {
      padding-left:10px;
      padding-top:5px;
    }

    #helpEngine {
      flex:1;
    }

    #helpEngine ul {
      list-style-type: none;
    }

    hr {
      width: 95%;
    }
  </style>
</head>

<body>

  <div id="header">
    <!-- do we want something here? -->
  </div>
  <div id="left">
    <div id="inputContainer">
      <div id="toolbar">
  
        <select id="scriptsList" class="toolbarItem">
          <option value="NOTASCRIPTNAME">Choose a script...</option>
          <!-- generated code below: -->
          <!-- scripts list -->
        </select>
        <div id="btnPlay" class="btn toolbarItem disabled">&#9658;</div>
        <div id="btnStop" class="btn toolbarItem disabled" style="display:none;">&#9724;</div>
        <div id="btnNew" class="btn toolbarItem">New</div>
        <div id="btnSave" class="btn toolbarItem disabled">Save</div>
        <div id="btnSaveDisk" class="btn toolbarItem disabled">Save to disk</div>
        <div id="btnRevert" class="btn toolbarItem disabled">Revert</div>
        <div id="btnHelp" class="btn toolbarItem">?</div>
      </div>
      <textarea id="inputField">-- Select a script from the dropdown list above</textarea>
    </div>
    <div id="draggablebar"></div>
  </div>
  <div id="right">
    <div id="outputContainer">
      <div id="toolbar">
        <div id="btnClear" class="btn toolbarItem">Clear</div>
      </div>
      <textarea id="stdout"></textarea>
    </div>
  </div>
  <div id="footer">
      Copyright (c) 2017 Anki, Inc. <span id="playingScripts"></span>
  </div>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        Help
      </div>
      <div class="modal-body">
        
        <div class="modal-section" style="width: 20%;"> 
          <b>What is this?</b><br/>
          This page allows you to write scripts in <a href="https://www.lua.org/" target="_blank">Lua</a> that are interpreted in BaseStation, allowing you to observe state and control the vehicles.  <br/><br/>

          You have two global objects, <b><code>world</code></b> and <b><code>engine</code></b>, described to the right.<br/><br/>

          <hr/>

          Want to learn Lua? Try this free <a href="https://www.lua.org/pil/contents.html" target="_blank">book</a> by a creator of Lua.
        </div>
        <div class="modal-section" style="flex:.75;" > 
          The variable <b><code>world</code></b> contains: 

          <ul>
            <li><code>vehicles</code>: array of <code><span class="div-link">LuaWorldVehicle</span></code></li>
            <li><code>players</code>: array of <code><span class="div-link">LuaWorldPlayer</span></code></li>
            <li><code>time</code>: float; BaseStation time</li>
            <li><code>track</code>: string like 'LLLSRRSS', not used in OSX </li>
          </ul>

          <hr/>

          <code><span class="div-target">LuaWorldVehicle</span></code> contains:
          <ul>
            <li><code>id</code>: int</li>
            <li><code>player</code>: occupying <code><span class="div-link">LuaWorldPlayer</span></code></li>
            <li><code>energy</code>: float in [0,1]</li>
            <li><code>state</code>: <code><span class="div-link">LuaWorldVehicleState</span></code>, see below</li>
          </ul>

          <hr/>

          <code><span class="div-target">LuaWorldPlayer</span></code> contains:
          <ul>
            <li><code>id</code>: int</li>
            <li><code>isAI</code>: bool</li>
            <li><code>rank</code>: int</li>
            <li><code>kills</code>: int</li>
            <li><code>deaths</code>: int</li>
            <li><code>laps</code>: int</li>
          </ul>

          <hr/>

          <code><span class="div-target">LuaWorldVehicleState</span></code> contains:
          <ul>
            <li><code>lane</code>: int</li>
            <li><code>targetLane</code>: int</li>
            <li><code>laneChanging</code>: bool</li>
            <li><code>distFromStartLine</code>: float</li>
            <li><code>roadPieceIndex</code>: int</li>
            <li><code>distInRoadPiece</code>: float</li>
            <li><code>drivingReverse</code>: bool</li>
            <li><code>speed</code>: float</li>
            <li><code>lastCommandedSpeed</code>: float</li>
            <li><code>localized</code>: bool</li>
          </ul>
          Remember that Lua arrays are 1-indexed, so the first drivable lane is 3, compared to 2 in BaseStation.

          <hr/>

          Want more functionality? Add to luaWorld.h.

        </div>


        <div class="modal-section" id="helpEngine"> 
          The variable <b><code>engine</code></b> is a table of functions, organized and nested by component into tables, that may be called to control BaseStation or request callbacks when certain BaseStation events occur. Functions below are shown with example parameters, and note that all parameters that index a vehicle, lane, etc. are 1-indexed. <br/>
          
          <hr/>

          <ul>
            <li>
              <code>engine.driving.set_lane(1, {lane=5, speed = 0.2})</code> <br/> Sets the speed of the vehicle to the desired lane. First param is a vehicleId, second is a table with keys lane and speed.
            </li>
            <li>
              <code>engine.driving.set_speed(1, {speed = 0.6, accel = 1.0})</code> Changes the speed of vehicle. First param is vehicleId, second is a table with keys lane and speed.
            </li>
          </ul>

          <hr/>

          <ul>
            <li>
              <code>engine.lights.set_engine(1, {r=0.2, g=0.5, b=0.6})</code> <br/> Sets the RGB color of the top light of the vehicle. First param is a vehicleId, second is a table with keys r, g, and b, which can either be all in [0,1] or all in [0, 255].
            </li>
          </ul>

          <hr/>

          <ul>
            <li>
              <code>engine.playback_sequences.create({name="mySeq", json="{}"})</code> <br/> Creates a playback sequence with a given name and json. See playbackSequences.json for format.
            </li>
            <li>
              <code>engine.playback_sequences.load(1, "mySeq")</code> <br/> Loads a playback sequence with a given name onto vehicle with the provided vehicleId. Returns a token that
              can be used to play/stop/unload it.
            </li>
            <li>
              <code>engine.playback_sequences.play(1, myToken)</code> <br/> Plays a playback sequence on a given vehicle based on the token returned from <code>engine.playback_sequences.load</code>.
            </li>
            <li>
              <code>engine.playback_sequences.stop(1, myToken)</code> <br/> Stops a playback sequence on a given vehicle based on the token returned from <code>engine.playback_sequences.load</code>.
            </li>
            <li>
              <code>engine.playback_sequences.unload(1, myToken)</code> <br/> Frees up a playback slot on the given vehicle occupied by the token returned from <code>engine.playback_sequences.load</code>.
            </li>
          </ul>


          <hr/>

          <ul>
            <li>
              <code>engine.callbacks.register({OnTransitionBar=MyFunc})</code> <br/> Takes a single table parameter, where keys are one of: <code>OnTransitionBar</code>, ... (more to come), and function is the lua function to call.
            </li>
            <li>
              <code>engine.callbacks.clear("OnTransitionBar")</code> <br/> Takes either a string (e.g., "OnTransitionBar") of the callback to clear, or no parameters to clear all callbacks.
            </li>
          </ul>

          <hr/>
          Want more functionality? Add to luaEngine.h.

        </div>
      </div>
    </div>
  </div>


  <script>

    // globals

    var inputEditor;
    var outputEditor;

    var socket;

    var localScriptStates = {};

    var initialDropdownValue;
    var previousSelectedValue;

    var hasSeenSaveWarning = false;

    var cachedButtonState; // dict of btn to bool, true if enabled

    var socketCallbacks = {};

    var ignoreOnChangeOnce = false;

    var newScriptCount = 0;

    var unsavedWarning = "Your work is unsaved! Are you sure you wish to continue?";


    // init

    $( function() {

      initialDropdownValue = $('#scriptsList').val();
      previousSelectedValue = initialDropdownValue;

      CreateEditors();

      SetupSocket();

      InitializeLocalScripts();

      InitializePlayingScriptsTimer();

      $('.div-link').click( function() { 
        var name = $(this).text();
        var target = $('.div-target:contains("' + name +'")');
        var container = $(this).closest('.modal-section');
        var newScrollPos = target.offset().top - container.offset().top + container.scrollTop();
        container.animate({
          'scrollTop': newScrollPos
        }, 300);
      });
    });

    function CreateEditors() {
      inputEditor = MakeEditor( $('#inputField'), {
        lineNumbers: true,
        readOnly: "nocursor",
        mode:  "lua",
        styleActiveLine: true,
        matchBrackets: true,
        theme: 'blackboard'
      });
      inputEditor.on("change", function(cm, change) { 
        if( ignoreOnChangeOnce ) {
          ignoreOnChangeOnce = false;
        } else {
          MarkAsUnsaved();
        }
      });

      outputEditor = MakeEditor( $('#stdout'), {
        readOnly: true
      });
    }

    function InitializeLocalScripts() {
      $("#scriptsList option").each(function(i){

        var scriptName = $(this).val();
        var elapsedTime = parseFloat($(this).data('elapsed-time'), -1.0);

        localScriptStates[scriptName] = {};
        localScriptStates[scriptName].originatedOnServer = true;
        localScriptStates[scriptName].serverHasVersion = true; // server has a copy
        localScriptStates[scriptName].saved = true; // currently saved
        localScriptStates[scriptName].playing = (elapsedTime>=0.0);
        localScriptStates[scriptName].elapsedTime = elapsedTime;
        localScriptStates[scriptName].lastUpdateTime = new Date().getTime() / 1000; // sec
      });
    }

    function InitializePlayingScriptsTimer() {
      setInterval( function() {
        var strings = [];
        var cnt=0;
        for( var scriptName in localScriptStates ) {
          if( localScriptStates.hasOwnProperty(scriptName) ){
            if( localScriptStates[scriptName].playing ) {
              var elapsedTime = localScriptStates[scriptName].elapsedTime;
              if( elapsedTime >= 0.0 ) {
                var lastUpdateTime = GetLocalState(scriptName).lastUpdateTime;
                var currTime = new Date().getTime() / 1000;
                elapsedTime += (currTime - lastUpdateTime);
                elapsedTime = Math.round(10*elapsedTime)/10;
                var padding = '';
                if( cnt == 0 ) {
                  padding = '     ';
                }
                strings.push( padding + scriptName + ' ' + elapsedTime + ' sec');
              }
            }
          }
        }
        strings.sort();
        var str = '';
        for( var i=0; i<strings.length; ++i ) {
          if( i != 0 ) {
            str += '              ';
          }
          str += strings[i];
          if( i != strings.length - 1 ) {
            str += '  |||  ';
          }
        }
        $('#playingScripts').text(str);
      }, 1000);
    }

    // websocket logic

    function SetupSocket() {
      var loc = window.location;
      var uri = "ws:" + "//" + loc.host + "/socket";
      socket = new WebSocket(uri);

      socket.onopen = function(){
        // first action is to subscribe to lua 
        var subscribe = {"type": "subscribe", "service": "lua"};
        socket.send( JSON.stringify(subscribe) ); 
        // notify that we've connected
        outputEditor.getDoc().setValue( outputEditor.getValue() + "Lua script output:\n");
      }

      socket.onmessage = function(msg){
        var data = JSON.parse(msg.data);

        if(data["type"] == "print") {
          outputEditor.getDoc().setValue( outputEditor.getValue() + data["data"]);
          outputEditor.execCommand("goDocEnd");
        } else if( data["type"] == "error" ) {
          outputEditor.getDoc().setValue( outputEditor.getValue() + "ERROR: " + data["data"] + "\n");
          outputEditor.execCommand("goDocEnd");
        } else {
          if( data["type"] == "luascriptcontents" ) {
            HandleScriptContents( data );
          } else if( data["type"] == "luastates") {
            HandleScriptStates( data );
          }

          // if this is a response to a SocketSendWithCallback, fire it
          if( typeof socketCallbacks[data["type"]] !== 'undefined' ) {
            socketCallbacks[data["type"]].callback();
            clearTimeout(socketCallbacks[data["type"]].timer);
            socketCallbacks[data["type"]] = {};
          }
        }

        return false; // keep open
      }

      socket.onclose = function(e){
        var closeStr = "Connection to OverDrive closed.";
        outputEditor.getDoc().setValue( outputEditor.getValue() + closeStr + "\n");
        localScriptStates = {}

        // disable everything
        PushButtonState();
      } 
      socket.onerror=function (evt) {
        outputEditor.getDoc().setValue( outputEditor.getValue() + "WebSockets error: " + e.code + " " + e.reason + "\n");
        // disable everything
        PushButtonState();
      } 

    }

    function SocketSend( data ) {
      if( typeof socket !== 'undefined' ) {
        socket.send( JSON.stringify(data) ); 
      }
    }

    function SocketSendWithCallback(payload, waitForStr, onReceipt, onTimeout) {
      socketCallbacks[waitForStr] = {};
      socketCallbacks[waitForStr].callback = onReceipt;
      var duration = 1000; // ms
      socketCallbacks[waitForStr].timer = setTimeout( function() {
        if( typeof onTimeout !== 'undefined' ) {
          onTimeout();
        } else {
          var str = outputEditor.getValue() + "TIMEOUT: with " + JSON.stringify(payload)
                    + " timed out waiting for " + waitForStr + " after " + duration + " ms\n";
          outputEditor.getDoc().setValue( str );
          outputEditor.execCommand("goDocEnd");
        }
      }, duration);

      SocketSend(payload);
    }

    // on socket message received functions

    function HandleScriptContents(data) {

      var scriptName = data["script"];
      var contents = data["contents"];
      var elapsedTime = data["elapsedTime"];
      elapsedTime = parseFloat(elapsedTime,-1.0);

      GetLocalState(scriptName).serverHasVersion = true; // came from server
      GetLocalState(scriptName).elapsedTime = elapsedTime;
      GetLocalState(scriptName).playing = elapsedTime>=0.0;
      GetLocalState(scriptName).lastUpdateTime = new Date().getTime() / 1000; // seconds since 1970

      if( scriptName == GetCurrentScriptName() ) {

        ignoreOnChangeOnce = true;
        inputEditor.setValue( contents );        
        OnResize(); // width may have changed
      }      

      if( elapsedTime >= 0.0 ) {
        MarkAsPlaying(scriptName) 
      } else {
        MarkAsStopped(scriptName) 
      }
      
    }

    function HandleScriptStates(data) {
      var scripts = data["data"];

      var playingScripts = [];
      for (var scriptName in scripts) {
        if( scripts.hasOwnProperty(scriptName) ) {
          if( scripts[scriptName] >= 0.0 ) {
            playingScripts.push(scriptName);
            MarkAsPlaying(scriptName);
          }

          GetLocalState(scriptName).serverHasVersion = true; // came from server
          GetLocalState(scriptName).elapsedTime = scripts[scriptName];
          GetLocalState(scriptName).lastUpdateTime = new Date().getTime() / 1000; // seconds since 1970
        }
      }


      // mark local scripts no longer in this response as stopped
      for (var scriptName in localScriptStates) {
        if( localScriptStates.hasOwnProperty(scriptName) ) {
          if( $.inArray(scriptName, playingScripts) == -1 ) {
            // local scripts not in playingscripts
            MarkAsStopped(scriptName);
          }
        }
      }

    }

    // info about scripts

    function GetCurrentScriptName() {
      var scriptName = $('#scriptsList').val();
      if( scriptName == 'NOTASCRIPTNAME' ) {
        return '';
      } else {
        return scriptName;
      }
    }

    function DoesScriptHaveRemote(scriptName) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }
      return GetLocalState(scriptName).serverHasVersion;
    }

    function CanScriptRevert(scriptName) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }
      return GetLocalState(scriptName).originatedOnServer;
    }

    function IsScriptSaved(scriptName) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }
      return GetLocalState(scriptName).saved;
    }

    // modify local script states

    function MarkAsSaved(scriptName, justHitSave) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }

      GetLocalState(scriptName).saved = true;
      if( typeof justHitSave !== 'undefined' && justHitSave ) {
        GetLocalState(scriptName).serverHasVersion = true;
      }

      if( scriptName == GetCurrentScriptName() ) {
        $('#btnSave').addClass('disabled');
        $('#btnSaveDisk').addClass('disabled');
        $('#btnRevert').addClass('disabled');
        if( DoesScriptHaveRemote(scriptName) ) {
          $('#btnPlay').removeClass('disabled');
          $('#btnStop').removeClass('disabled');
        } else {
          $('#btnPlay').addClass('disabled');
          $('#btnStop').addClass('disabled');
        }
      }
    }

    function MarkAsUnsaved(scriptName) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }

      if( scriptName == GetCurrentScriptName() ) {
        $('#btnSave').removeClass('disabled');
        $('#btnSaveDisk').removeClass('disabled');
        if( CanScriptRevert(scriptName) ) {
          $('#btnRevert').removeClass('disabled');
        }
        // if play is being shown, dont allow a click. stop
        // is fine even if the current script is unsaved
        $('#btnPlay').addClass('disabled');
      }

      GetLocalState(scriptName).saved = false;
    }

    function MarkAsPlaying(scriptName) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }

      if( scriptName == GetCurrentScriptName() ) {
        $('#btnPlay').hide();
        $('#btnStop').show();
      }
      GetLocalState(scriptName).playing = true;
    }

    function MarkAsStopped(scriptName) {
      if( typeof scriptName === 'undefined' ) {
        scriptName = GetCurrentScriptName();
      }

      if( scriptName == GetCurrentScriptName() ) {
        $('#btnStop').hide();
        $('#btnPlay').show();
      }
      GetLocalState(scriptName).playing = false;
    }

    function GetLocalState(scriptName) {
      if( typeof localScriptStates[scriptName] === 'undefined' ) {
        // doesnt exist, populate defaults for non-server 
        localScriptStates[scriptName] = {};
        localScriptStates[scriptName].originatedOnServer = false;
        localScriptStates[scriptName].serverHasVersion = false;
        localScriptStates[scriptName].saved = false;
        localScriptStates[scriptName].playing = false;
        localScriptStates[scriptName].elapsedTime = -1.0;
        localScriptStates[scriptName].lastUpdateTime = 0;
      }
      return localScriptStates[scriptName];
    }

    // disable everything, saving state
    function PushButtonState() {
      cachedButtonState = {};
      $('.btn').each( function() {
        cachedButtonState['#' + this.id] = !$(this).hasClass('disabled');
        $(this).addClass('disabled');
      });
      $('#scriptsList').prop("disabled", true);
      inputEditor.setOption('readOnly', 'nocursor');
    }
    
    // re-enable based on previous state
    function PopButtonState() {
      if( typeof cachedButtonState !== 'undefined') {
        for( var key in cachedButtonState ) {
          if( cachedButtonState[key] ) {
            $(key).removeClass('disabled');
          } else {
            $(key).addClass('disabled');
          }
        }
      }
      $('#scriptsList').prop("disabled", false);
      inputEditor.setOption('readOnly', false);

      cachedButtonState={};
    }
    
    // ui interaction

    $('#scriptsList').change( function() {
      
      if( (previousSelectedValue != initialDropdownValue) && !IsScriptSaved(previousSelectedValue) ) {
        if( !confirm(unsavedWarning) ) {
          $('#scriptsList').val(previousSelectedValue);
          return;
        }
      }

      PushButtonState();

      var defaultOption = $('#scriptsList option[value="' + initialDropdownValue + '"]');
      if( typeof defaultOption !== 'undefined' ) {
        defaultOption.remove();
      }

      var selected = this.value;
      previousSelectedValue = selected;

      var payload = { type: 'luaget', script: selected };   
      SocketSendWithCallback(payload, 'luascriptcontents', function() {
        PopButtonState();
        MarkAsSaved(selected);
        inputEditor.focus();
      });
    });
  
    $('#btnClear').click(function() {
      outputEditor.setValue( '' );
    });

    $('#btnNew').click( function() {
      if( $(this).hasClass('disabled') ) {
        return;
      }

      if( (GetCurrentScriptName()!='') 
          && (GetCurrentScriptName() != initialDropdownValue) 
          && !IsScriptSaved(GetCurrentScriptName()) ) 
      {
        if( !confirm(unsavedWarning) ) {
          return;
        }
      }

      var strScriptCount = '';
      if( newScriptCount > 0 ){
        strScriptCount = newScriptCount.toString();
      }
      var filename = prompt("Please enter a filename", "myScript" + strScriptCount + ".lua");

      // if not canceled
      if( !(filename == null || filename == "") ) {

        var scriptName = filename;
        if( filename.substring(filename.length - 4) == '.lua' ) {
          scriptName = filename.substring(0, filename.length - 4);
        } else {
          alert('ERROR: File must have a .lua extension');
          return;
        }
        // todo: regex for a filename
        if( scriptName.indexOf(' ') >= 0 ) {
          alert('ERROR: Invalid filename');
          return;
        }
        // no dupes
        var dupe = false;
        $('#scriptsList option').each(function () {
          if( $(this).val() == scriptName ) {
            dupe = true;
          }
        });

        if( dupe ) {
          alert('ERROR: There is already a script with the name ' + scriptName + '.lua');
          return;
        }

        // go ahead with a new file now

        newScriptCount = newScriptCount + 1;

        $('#scriptsList option[value="' + initialDropdownValue + '"]').remove();
        // remove the unsaved ones
        $('#scriptsList option').each(function(i){
          var scriptName = $(this).val();
          if( !IsScriptSaved(scriptName) ) {
            $(this).remove();
          }
        });
        // add a new dropdown option
        $('#scriptsList').append($('<option>', {
            value: scriptName,
            text: scriptName + '.lua'
        }));

        // sort the options
        $("#scriptsList").html($('#scriptsList option').sort(function(x, y) {
          return $(x).text() < $(y).text() ? -1 : 1;
        }) );

        inputEditor.setOption('readOnly', false);
        inputEditor.setValue('');

        MarkAsSaved();
        
        // select it
        $('#scriptsList').val(scriptName);

        // update play/stop buttons
        $('#btnPlay').show().addClass('disabled');
        $('#btnStop').hide();


        inputEditor.focus();
      }
    });

    $('#btnSave').click( function() {
      if( $(this).hasClass('disabled') ) {
        return;
      }

      PushButtonState(); //disable everything

      var scriptName = GetCurrentScriptName();
      var payload = { type: 'luaset', scriptName: scriptName, contents: inputEditor.getValue() };

      SocketSend(payload);

      if( !hasSeenSaveWarning ) {
        alert('Note that saving through this interface will only affect the current app run, and your changes will be lost if you close the app. You need to save the .lua file into the app resources. If you wish to do so, click \'Save to disk.\'');
        hasSeenSaveWarning = true;
      }

      PopButtonState();
      MarkAsSaved(scriptName, true);
      inputEditor.focus();

      
    });

    $('#btnSaveDisk').click(function() {
      if( $(this).hasClass('disabled') ) {
        return;
      }

      var contents = inputEditor.getValue();
      var scriptName = GetCurrentScriptName();

      var file = new Blob([contents], {type: 'text/plain'});

      // create a link to download it, click it, then remove that link
      var a = document.createElement("a");
      var url = URL.createObjectURL(file);
      a.href = url;
      a.download = scriptName + '.lua';
      document.body.appendChild(a);
      a.click();
      setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
        inputEditor.focus();
      }, 0); 
    });

    $('#btnRevert').click(function() {
      if( $(this).hasClass('disabled') ) {
        return;
      }

      var selectedName = GetCurrentScriptName();

      if( !IsScriptSaved(selectedName) ) {
        if( !confirm(unsavedWarning) ) {
          return;
        }
      }

      // lock
      PushButtonState();

      var payload = { type: 'luarevert', scriptName: selectedName };
      
      // send payload and wait til a response before unlocking
      SocketSendWithCallback(payload, 'luascriptcontents', function() {
        PopButtonState();
        MarkAsSaved(selectedName);
        inputEditor.focus();
        OnResize(); // width may have changed
      });

      
    });

    $('#btnPlay').click( function () {
      if( $(this).hasClass('disabled') ) {
        return;
      }

      if( !IsScriptSaved(GetCurrentScriptName()) ) {
        alert('ERROR: state got messed up. You shouldn\'t have been able to click that')
        return;
      }

      var cmd = 'luaplay';
      var scriptName = GetCurrentScriptName();
      var payload = { type: cmd, scriptName: scriptName };

      $('#btnPlay').hide();
      // tell to play. response will enable the stop button
      SocketSend( payload );
        

    });

    $('#btnStop').click( function () {
      if( $(this).hasClass('disabled') ) {
        return;
      }
      
      var cmd = 'luastop';
      var scriptName = GetCurrentScriptName();
      var payload = { type: cmd, scriptName: scriptName };

      $('#btnStop').hide();
      // tell to stop. response will enable the play button
      SocketSend( payload );

    });

    // editor ui 

    function MakeEditor(textArea,args) {
      var inputField = textArea[0];
      var newHeight = textArea.parent().css('height');
      var editor = CodeMirror.fromTextArea(inputField, args);
      textArea.next().css('height',newHeight);
      return editor;
    }

    function OnResize() {
      var newHeight = $('#inputField').parent().css('height');
      $('#inputField').next().css('height',newHeight);

      newHeight = $('#stdout').parent().css('height');
      $('#stdout').next().css('height',newHeight);
    }

    $( window ).resize(function() {
      OnResize();
    });

    // draggable divider

    $('#draggablebar').mousedown(function(e){
     
      e.preventDefault();
      var oldLeft = parseInt($('#right').css("left"), 0);
      var oldWidth = parseInt($('#right').css("width"), 0);
      // $('#mousestatus').html("mousedown" + i++);
      $(document).mousemove(function(e){
        $('#position').html('pos=' + oldWidth + ' ' + oldLeft + ' x=' + (e.pageX+2) + ' diff=' + (e.pageX+2-oldLeft) + ' new=' + (oldWidth - (e.pageX+2-oldLeft))  );//e.pageX +', '+ e.pageY);
        var minWidthLeft = 400;
        var minWidthRight = 200;
        var newLeftWidth = Math.max(minWidthLeft, e.pageX+2);
        newLeftWidth = Math.min(newLeftWidth, oldWidth+oldLeft-minWidthRight);
        $('#left').css("width",newLeftWidth);
        $('#right').css("left",newLeftWidth).width(oldWidth - (newLeftWidth-oldLeft) );
      });
    });

    $(document).mouseup(function(e){
      $(document).unbind('mousemove');
    });

    // help

    $('#btnHelp').click(function() {
      $('.modal').css('display','block');
    });

    $('.close').click(function() {
      $('.modal').css('display','none');
    });

    $( window).click( function(event) {
      if( event.target == $('.modal')[0] ){
        $('.modal').css('display','none');
      }
    });

  </script> 

</body>
</html>

