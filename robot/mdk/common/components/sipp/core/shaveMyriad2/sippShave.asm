;-------------------------------------------------------------------------------
;
.version 00.51.05
;
; Generated by 'moviCompile v00.50.35.20'
;-------------------------------------------------------------------------------

.include "myriad2SippDefs.inc"

.set __top_of_stack 0x1e000c00


.data __STACK__sect 0x1e000c00

    shave_sp:
        .label shave_sp


.code .text.__MAIN__sect
.salign 16



 .lalign
 main:

   ;Init Stack 
    LSU0.LDIL  i19, shave_sp     ||  LSU1.LDIH i19, shave_sp

  ;#####################################################################
   waitLeonStart:
        LSU0.LDIL  i0, sipp_pl      ||  LSU1.LDIH i0, sipp_pl 
        LSU0.LD.32 i0, i0
        nop 6

   _waitLeonStartLoop:
        lsu0.ldo.32 i1, i0, P_O_SVU_CMD
        nop 50
        iau.or i1, i1, i1
        peu.pc1i EQ || bru.bra _waitLeonStartLoop
        nop 6



  ;#####################################################################
   barrierInit:
	lsu0.ldo.32 i2, i0, (P_O_GLOBAL_NFO + G_O_FIRST_S)
	cmu.cpti i1, P_SVID
	nop 5
	iau.sub i1, i2, i1
	peu.pc1i NEQ || bru.bra barrierInitDone
	nop 6 ;nops to save BW (i.e. the following loads)

   ;~~~~~~~~~~~~~~~~~~~~~~~
   barrierInitMaster:
      ;copy pre-set START mask to STATUS field to indicate running
       lsu0.ldo.32 i3, i0, (P_O_SVU_START_M + 0x00)
       lsu0.ldo.32 i4, i0, (P_O_SVU_START_M + 0x04)
       lsu0.ldo.32 i5, i0, (P_O_SVU_START_M + 0x08)
       nop 4
       lsu0.sto.32 i3, i0, (P_O_SVU_STAT    + 0x00)
       lsu0.sto.32 i4, i0, (P_O_SVU_STAT    + 0x04)
       lsu0.sto.32 i5, i0, (P_O_SVU_STAT    + 0x08)

   ;~~~~~~~~~~~~~~~~~~~~~~~
   barrierInitDone:
       ;nothing...


  ;#####################################################################
  ;process the workload:
        LSU0.LDIL  i10, sipp_pl      ||  LSU1.LDIH i10, sipp_pl 
        LSU0.LD.32 i28, i10
        NOP 6
        CMU.CPII i10 i28
        IAU.INCS i10 P_O_SVU_LIST_SZ
        LSU0.LD.32 i27 i10
        NOP 6
        CMU.CMZ.i32 i27
        PEU.PC1C EQ            ||  BRU.BRA ___main_5
        NOP 6
        
    .lalign
___main_1:
        CMU.CPII i9 i28
        IAU.INCS i9 P_O_ITER
        CMU.CPII i10 i28       ||  LSU0.LD.32 i9 i9
        IAU.INCS i10 P_O_SCHED_NFO
        LSU0.LD.32 i10 i10
        LSU1.LDIL i25 0x0001
        NOP 3
        IAU.MUL i9 i9 SZ_SCH_INFO
        NOP 1
        IAU.ADD i10 i10 i9
        IAU.ADD i10 i10 S_O_SVU_MASK
        LSU0.LD.32 i26 i10
        NOP 3
        LSU0.LDIL i29 0
        CMU.CPII i24 i29             ;i=0
    .lalign
___main_2:
        IAU.SHL i10 i25 i24
        IAU.AND i10 i10 i26
        CMU.CMZ.i32 i10
        PEU.PC1C EQ  ||  BRU.BRA ___main_4
        NOP 6
        
    .lalign
___main_3:
        IAU.SHL i10 i24 2           ;*4 as a sizeof(ptr = 4Bytes)
        IAU.ADD i10 i28 i10
        IAU.ADD i10 i10 P_O_SVU_LIST
        LSU0.LD.32 i18 i10
        NOP 6
        IAU.ADD i17 i18 F_O_SVU_RUN  ;offset to fptr->funcSvuRun
        LSU0.LD.32 i10 i17           ;WARNING: i10 loads after 6 cycles
        IAU.ADD i10 i18 F_O_EXENO    ;uses OLD i10
        LSU0.LD.32 i16 i10           ;uses OLD i10
        NOP 4
        CMU.CPII i30 i10             ;copy i10 to i30 and call
        CMU.CPII i17 i29
        BRU.SWP i30                  ;call fptr->funcSvuRun
        NOP 6
        
    .lalign
___main_4:
        IAU.ADD i24 i24 1            ;i++
        CMU.CMII.i32 i27 i24         ;compare to nFiltersSsvu
        PEU.PC1C NEQ  ||  BRU.BRA ___main_2
        NOP 6


        
    .lalign
___main_5:
       
    ;#####################################################################
    barrierWait:

      ;Mark we're done current task list:
        LSU0.LDIL  i0, sipp_pl      || LSU1.LDIH i0, sipp_pl 
        LSU0.LD.32 i0, i0
        nop 6
        cmu.cpii   i1, i0
        iau.incs   i1, P_O_SVU_STAT || cmu.cpti  i2, P_SVID
        iau.add    i1, i1, i2       || lsu0.ldil i3, 0
        lsu0.st.8  i3, i1

      ;Master/Shave select:
        lsu0.ldo.32 i4, i0, (P_O_GLOBAL_NFO + G_O_FIRST_S)
        nop 6
        iau.sub i4, i2, i4
        peu.pc1i EQ || bru.bra barrierWaitMaster
        nop 6

    ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    barrierWaitSlave: 
    barrierWaitSlaveLoop: 
      ;wait till Master clears the global status word
        lsu0.ldo.32 i1, i0, P_O_SVU_CMD
        nop 6
        iau.or i1, i1, i1
        peu.pc1i NEQ || bru.bra barrierWaitSlaveLoop
        nop 6
        bru.bra barrierWaitEnd
        nop 6
    
    ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    barrierWaitMaster: 
       
     ;Wait for all Shaves to reach IDLE state
      barrierWaitMasterLoop:
       lsu0.ldo.32 i3, i0, (P_O_SVU_STAT    + 0x00)
       lsu0.ldo.32 i4, i0, (P_O_SVU_STAT    + 0x04)
       lsu0.ldo.32 i5, i0, (P_O_SVU_STAT    + 0x08)
       nop 5
       iau.or i3, i3, i4
       iau.or i3, i3, i5
       peu.pc1i NEQ || bru.bra barrierWaitMasterLoop
       nop 6
  
     ;Then tell LEON and the other Slaves that we're done
       lsu0.ldil   i3, 0
       lsu0.sto.32 i3, i0, P_O_SVU_CMD

     ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      barrierWaitEnd:
   
      ;TBD:
          bru.bra waitLeonStart
          nop 6


      ;TBD: do a graceful shave stopp here !!!
      ;stop: 
        LSU0.LDIL i18 0
        BRU.SWIH 0x001f
        nop 6









;-------------------------------------------------------------------------------
.data .data.__static_data_Pcfa92cb9_a1613523T_
.salign 16

    .align 4
    sipp_pl:
        .word 0

.unset __top_of_stack

.end

 
