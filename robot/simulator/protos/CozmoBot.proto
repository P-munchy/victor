#VRML_SIM V7.3.0 utf8
PROTO CozmoBot [
  field SFVec3f translation 0 0 0
  field SFRotation rotation 0 0 1 0
  field SFString name "Cozmo"

  field SFInt32  cameraWidth  320
  field SFInt32  cameraHeight 240
  field SFFloat fieldOfView   0.92

  field SFFloat headAngle          0
  field SFFloat headAngle_lowLimit -0.4363 # 25 degrees down
  field SFFloat headAngle_highLimit 0.6109 # 35 degrees up
  
  field SFFloat liftAngle 0
  field SFFloat liftAngle_lowLimit  0
  field SFFloat liftAngle_highLimit 1.047  # 60 degrees up
  
  field SFInt32 usbChannel 88
  
  field SFString controller "cozmo_c_controller"
  field SFString controllerArgs ""

  field SFColor bodyColor 0.92 0.92 0.8

  # Set to TRUE if you just want to use the model for visualization.
  field SFBool vizMode FALSE
]
{

Supervisor {
  translation IS translation
  rotation IS rotation
  name IS name

  %{ if not fields.vizMode then }%
  controller IS controller
  controllerArgs IS controllerArgs
  %{ else }%
  controller ""
  controllerArgs ""
  %{ end }%
  
  %{ if not fields.vizMode then }%
  physics Physics {
    density 5000
    #mass 0.17 # about 6 ounces
  }
  %{ end }%
  
  children [
    Transform {
      translation 0 0 0.0142 # wheel radius
      children [ 
    
		# Comms for sending paths for drawing to the physics plugin
		Emitter { 
		  name "cozmo_physics_comms"
		}
   
		# For simulated USB connection to do "offboard" vision
		# processing
		Emitter {
		   name "usb_tx"
		   type "radio"
		   bufferSize 500000
		   channel IS usbChannel
		}
		Receiver {
		   name "usb_rx"
		   type "radio"
		   bufferSize 500000
		   channel IS usbChannel
		}
	
		# Are these still needed?
		GPS {
		  name "gps"
		  translation 0 0 0
		}    
		Compass {
		  name "compass"
		}
	
	
		DEF BODY Solid {
		  translation -0.015 0 0
		  children [
			DEF BODY_SHAPE Group { 
			  children [
				Transform {
				  translation 0.015 0 0
				  children [
					Shape {
					  appearance Appearance {
						material Material {
						  diffuseColor IS bodyColor
						  shininess 0
						}
					  }  
					  geometry Cylinder {
						height 0.0322
						radius 0.013
						subdivision 16
					  }
					}
				  ]
				}
				Transform {
				  translation -0.015 0 0
				  children [
					Shape {
					  appearance Appearance {
						material Material {
						  diffuseColor IS bodyColor
						}
					  }  
					  geometry Cylinder {
						height 0.0322
						radius 0.013
						subdivision 16
					  }
					}
				  ]
				}
				Shape {
				  appearance Appearance {
					material Material {
					  diffuseColor IS bodyColor
					}
				  }  
				  geometry Box {
					size 0.03 0.0322 0.026
				  }
				}
			  ] # BODY_SHAPE Group children
			} # BODY_SHAPE Group
		  ] # BODY Solid children
		  %{ if not fields.vizMode then }%
		  boundingObject USE BODY_SHAPE
		  physics Physics {
			 density 1500
		  }
		  %{ end }%
		} # BODY Solid
		
		DEF HEAD Transform {
		  translation -0.013 0 0.0335
		  children [
			HingeJoint {
			  jointParameters HingeJointParameters {
				dampingConstant 3
				position IS headAngle
				maxStop IS headAngle_highLimit
				minStop IS headAngle_lowLimit
				position 0
				axis 0 -1 0
			  }
			  %{ if not fields.vizMode then }%
			  device RotationalMotor {
				name "HeadMotor"
			  }
			  %{ end }%
			  endPoint Solid {            
				children [
				  DEF EAR_SQUARES Shape {
					appearance Appearance {
					  material DEF OrangePlastic Material {
						diffuseColor 0.8 0.404776 0
					  }
					}
					geometry Box {
					  size 0.005 0.0405 0.005
					}
				  }
				  DEF EARS Shape {
					appearance Appearance {
					  material Material {
						diffuseColor 0.5 0.5 0.5
					  }
					}
					geometry Cylinder {
					  height 0.040
					  radius 0.007
					  subdivision 16
					}
				  }
				  DEF EYES Transform {
					translation 0.02 0 0.002
					children [
					  DEF LEFT_EYE Transform {
						translation 0 0.006 0
						rotation 0 0 1 1.5708
						children [
						  DEF EYE_SHAPE Shape {
							appearance Appearance {
							  material Material {
								ambientIntensity 0.1
								diffuseColor 0 0 0
								emissiveColor 0.1 0.5 1
							  }
							}
							geometry Cylinder {
							  height 0.002
							  radius 0.005
							  subdivision 16
							}
						  }
						]
					  }
					  DEF RIGHT_EYE Transform {
						translation 0 -0.006 0
						rotation 0 0 1 1.5708
						children [
						  USE EYE_SHAPE
						]
					  }
					  DEF LEFT_EYE_CENTER Transform {
						translation 0 0.006 0
						rotation 0 0 1 1.5708
						children [
						  DEF EYE_CENTER_SHAPE Shape {
							appearance Appearance {
							  material Material {
								diffuseColor 0.5 0.5 0.5
							  }
							}
							geometry Cylinder {
							  height 0.0021
							  radius 0.0035
							  subdivision 16
							}
						  }
						]
					  }
					  DEF RIGHT_EYE_CENTER Transform {
						translation 0 -0.006 0
						rotation 0 0 1 1.5708
						children [
						  USE EYE_CENTER_SHAPE
						]
					  }
					]
				  }
				  Camera {
					name "HeadCamera"
					# Note: 8.8mm to lens face, 5.8mm to PCB mount, optical center = ?
					translation 0.0058 0 -0.006
					rotation 0.57735 -0.57735 -0.57735 2.0944
					width IS cameraWidth
					height IS cameraHeight
					fieldOfView IS fieldOfView
					near 0.018
					antialiasing TRUE
				  }
				  Gyro {
				  	name "gyro"
					translation 0.0058 -0.0135 0

					# +/- 500 deg/s range expressed by 16-bits
					# resolution 0.0002663
				  }
				  Accelerometer {
					name "accel"
					translation 0.0058 -0.0135 0

					# +/-2g (+/- 19.62m/s^2) range expressed by 12-bits
					# resolution 0.00958
				  }
				  DEF FACE Transform {
					translation 0.016 0 0
					rotation 0 0 1 1.5708
					children [
					  Shape {
						appearance Appearance {
						  material DEF DarkGray Material {
							diffuseColor 0.5 0.5 0.5
						  }
						}
						geometry DEF FACE Cylinder {
						  height 0.008
						  radius 0.015
						  subdivision 24
						}
					  }
					]
				  }
				  DEF HEAD_SPHERE Shape {
					geometry Sphere {
					  radius 0.020
					  subdivision 3
					}
					appearance Appearance {
					  material Material {
					    diffuseColor IS bodyColor
					  }
				    }
				  }
				]
				name "head"

				%{ if not fields.vizMode then }%
				boundingObject USE HEAD_SPHERE
				physics Physics {
					density 100
				}
				%{ end }%
			  }
			}
		  ]
		} # DEF HEAD Transform
	
		DEF BACKPACK Solid {
		  translation -0.04 0 0.018
		  children [
		    DEF BACKPACK_GROUP Group {
		      children [
			Transform {
			  children [
				Shape {
				  appearance Appearance {
					material Material {
					  diffuseColor IS bodyColor
					}
				  }  
				  geometry Box {
					size 0.03 0.03905 0.0206
				  }
				}
			  ]
			}
			Transform {
			  translation 0 0 0.0113
			  children [
				Shape {
				  appearance Appearance {
					material Material {
					  diffuseColor IS bodyColor
					}
				  }  
				  geometry Cylinder {
					height 0.039
					radius 0.015
					subdivision 20
				  }
				}
			  ]
			}
			Transform {
			  translation 0 0 -0.0113
			  children [
				Shape {
				  appearance Appearance {
					material Material {
					  diffuseColor IS bodyColor
					}
				  }  
				  geometry Cylinder {
					height 0.039
					radius 0.015
					subdivision 20
				  }
				}
			  ]
			}
		      ]
		    }                      
		  ] # BACKPACK Solid children

		  %{ if not fields.vizMode then }%
	          boundingObject USE BACKPACK_GROUP
		  physics Physics {
			density 2000
		  }
		  %{ end }%
		} # BACKPACK Solid

		DEF CASTER Solid {
		  translation -0.03 0 -0.009575
		  children [
			Shape {
			  appearance Appearance {
				material Material {
				  diffuseColor 0.57995 0.464927 0.275319
				}
			  }
			  geometry DEF CASTER_SHAPE Cylinder {
				height 0.010
				radius 0.004625
				subdivision 32
			  }
			}
		  ]
		  contactMaterial "nofriction"

		  %{ if not fields.vizMode then }%
		  boundingObject USE CASTER_SHAPE
		  physics Physics {
			 density 5000
		  }	
		  %{ end }%
		} # CASTER Solid
	
		DEF LEFT_FRONT_WHEEL HingeJoint {
		  jointParameters HingeJointParameters {
			dampingConstant 3
			axis 0 1 0
		  }
		  device RotationalMotor {
			name "LeftWheelMotor"
			maxVelocity 30
		  }
		  endPoint Solid {
			translation 0 0.02385 0
			children [
			  Transform {
				translation 0 -0.00225 0
				children [
				  DEF DRIVE_HUB Group {
					children [
					  Shape {
						appearance Appearance {
						  material DEF WHEEL_HUB_MATERIAL Material {
							diffuseColor 0.6 0.6 0.6
						  }
						}
						geometry Cylinder {
						  height 0.011
						  radius 0.0132
						  subdivision 22
						}
					 }
					 Transform {
					   translation .005 0 0
					   children [
						 Shape {
						   appearance Appearance {
							 material USE OrangePlastic
						   }
						   geometry Box {
							 size .01 .0125 .004
						   }
						 }
						]
					  }
					]
				  }
				]
			  }
			  DEF DRIVE_TIRE Shape {
				appearance Appearance {
				  material Material {
					diffuseColor 0.25 0.25 0.25
				  }
				}
				geometry Cylinder {
				  height 0.003
				  radius 0.0142
				  subdivision 32
				}
			  }
			]
			contactMaterial "highfriction"

			%{ if not fields.vizMode then }%
			boundingObject USE DRIVE_TIRE
			physics DEF WHEEL_PHYSICS Physics {
			  density 1000
			}
			%{ end }%
		  }
		}
		DEF RIGHT_FRONT_WHEEL HingeJoint {
		  jointParameters HingeJointParameters {
			dampingConstant 3
			axis 0 1 0
		  }
		  device RotationalMotor {
			name "RightWheelMotor"
			maxVelocity 30
		  }
		  endPoint Solid {
			translation 0 -0.02385 0
			children [
			  Transform {
				translation 0 0.00225 0
				children [
				  USE DRIVE_HUB
				]
			  }
			  USE DRIVE_TIRE
			]
			contactMaterial "highfriction"

			%{ if not fields.vizMode then }%
			boundingObject USE DRIVE_TIRE
			physics USE WHEEL_PHYSICS
			%{ end }%
		  }
		}
		DEF REAR_AXLE Transform {
		  translation -.03 0 0 
		   children [
			DEF LEFT_REAR_WHEEL HingeJoint {
			  jointParameters HingeJointParameters {
				axis 0 1 0
			  }
			  endPoint Solid {
				translation 0 0.02385 0
				children [
				  Transform {
					translation 0 -0.00225 0
					children [
					  DEF REAR_HUB Shape {
						appearance Appearance {
						  material USE WHEEL_HUB_MATERIAL
						}
						geometry Cylinder {
						  height 0.011
						  radius 0.0127
						  subdivision 22
						}
					  }
					]
				  }
				  DEF REAR_TIRE Shape {
					appearance Appearance {
					  material Material {
						diffuseColor 0.25 0.25 0.25
					  }
					}
					geometry Cylinder {
					  height 0.003
					  radius 0.0137
					  subdivision 22
					}
				  }
				]
				contactMaterial "nofriction"

				%{ if not fields.vizMode then }%
				boundingObject USE REAR_TIRE
				physics USE WHEEL_PHYSICS
				%{ end }%
			  }
			}
			DEF RIGHT_REAR_WHEEL HingeJoint {
			  jointParameters HingeJointParameters {
				axis 0 1 0
			  }
			  endPoint Solid {
				translation 0 -0.02385 0
				children [
				  USE REAR_TIRE
				  Transform {
					translation 0 0.00225 0
					children [
					  USE REAR_HUB
					]
				  }
				]
				contactMaterial "nofriction"

				%{ if not fields.vizMode then }%
				boundingObject USE REAR_TIRE
				physics USE WHEEL_PHYSICS
				%{ end }%
			  }
			}
		  ] # Transform children
		} # Rear Wheel Transform
	
		DEF LIFT Transform {
		  translation -0.04 0 0.0295
	  
		  children [
			Shape {
			  geometry Cylinder {
				height 0.048
				radius 0.003
				subdivision 14
			  }
			}
			DEF SHOULDER HingeJoint {
			  jointParameters HingeJointParameters {
				axis 0 -1 0
				dampingConstant 3
				position IS liftAngle
				minStop IS liftAngle_lowLimit
				maxStop IS liftAngle_highLimit
			  }
			  %{ if not fields.vizMode then }%
			  device RotationalMotor {
				name "LiftMotor"
				maxVelocity 2
				maxTorque 2
			  }
			  %{ end }%
			  endPoint Solid {
				children [

				#GRIPPER PLATE
				Transform {
					translation 0.0626 0 -0.012
					children [
					  HingeJoint {
						jointParameters HingeJointParameters {
						  axis 0 1 0
						  dampingConstant 3
						  position IS liftAngle
						  minStop IS liftAngle_lowLimit
						  maxStop IS liftAngle_highLimit
						}
						endPoint DEF SmallFingerGripper Solid {
						  children [
							Transform {
							  translation 0.0035 -0.017 -0.012
							  children [
								DEF GRIPPER_FINGER Group {
								  children [
									DEF GRIPPER_FINGER_SHAPE Shape {
									  appearance Appearance {
										material Material { 
										  diffuseColor IS bodyColor
									    }
									  }
									  geometry DEF GRIPPER_FINGER_SHAPE IndexedFaceSet {
										coord Coordinate {
										  point [
											0 0.00075 0
											0 0.00075 0.0075
											0.0026 0.00075 0.0075
											0.0046 0.00075 0.0108
											0.006 0.00075 0.0108
											0.006 0.00075 0.008
											0.0034 0.00075 0
											0 -0.00075 0
											0 -0.00075 0.008
											0.0026 -0.00075 0.008
											0.0046 -0.00075 0.0108
											0.006 -0.00075 0.0108
											0.006 -0.00075 0.008
											0.0034 -0.00075 0
										  ]
										}
										coordIndex [
										  0, 1, 6, -1, 1, 2, 6, -1, 2, 5
										  6, -1, 2, 3, 4, -1, 2, 4, 5, -1
										  13, 8, 7, -1, 13, 9, 8, -1, 13, 12
										  9, -1, 11, 10, 9, -1, 12, 11, 9, -1
										  1, 8, 2, -1, 2, 8, 9, -1, 3, 10
										  4, -1, 4, 10, 11, -1, 2, 9, 3, -1
										  3, 9, 10, -1, 4, 11, 12, -1, 4, 12
										  5, -1, 5, 12, 13, -1, 5, 13, 6, -1
										  13, 7, 0, -1, 6, 13, 0, -1
										]
									  }
									}
								  ] # GRIPPER_FINGER Group Children
								} # GRIPPER_FINGER Group
							  ] # Transform children
							} # Transform
							Transform {
							  translation 0.0035 0.017 -0.01
							  children [
								USE GRIPPER_FINGER
							  ]
							}
							
						    DEF LIFTER_SHAPE Group {
							  children [
								Transform {
								  translation 0 -0.0165 -0.01155
								  children [
									DEF GRIPPER_SIDE Shape {
									  geometry Box {
										size 0.007 0.004 0.0289
									  }
									  appearance Appearance {
									    material Material {
									      diffuseColor IS bodyColor
									    }
									  }
									}
								  ]
								}
								Transform {
								  translation 0 0.0165 -0.01155
								  children [
								    USE GRIPPER_SIDE
								  ]
								}
								Transform {
								  translation 0.001 0 -0.0235
								  children [
									DEF GRIPPER_BOTTOM Shape {
									  geometry Box {
										size 0.005 0.029 0.005
									  }
									  appearance Appearance {
									    material Material {
									      diffuseColor IS bodyColor
									    }
									  }
									}
								  ]
								}
								
								# Screws and washers
								Transform {
								  translation 0 -0.01375 0
								  children [
								    DEF LIFTER_SCREW Shape {
									  geometry Cylinder {
									    height .0025
									    radius .00175
									  }
									  appearance Appearance {
									    material Material {
						                  diffuseColor 0.7 0.7 0.7
						                  shininess 0.95
					                    } 
					                  }
								    }
								  ]
								}
								Transform {
								  translation 0 -0.014 0
								  children [
								    DEF LIFTER_WASHER Shape {
									  geometry Cylinder {
									    height .001
									    radius .003
									  }
									  appearance Appearance {
									    material Material {
						                  diffuseColor 1.0 1.0 1.0
						                  transparency 0.15
						                  shininess 0
						                }
					                  }
								    }
								  ]
								}
								
								Transform {
								  translation 0 0.01375 0
								  children [
								    USE LIFTER_SCREW
								  ]
								}
								Transform {
								  translation 0 0.014 0
								  children [
								    USE LIFTER_WASHER
								  ]
								}
								
								Transform {
								  translation 0 0.01375 -0.012
								  children [
								    USE LIFTER_SCREW
								  ]
								}
								Transform {
								  translation 0 0.014 -0.012
								  children [
								    USE LIFTER_WASHER
								  ]
								}
								
								Transform {
								  translation 0 -0.01375 -0.012
								  children [
								    USE LIFTER_SCREW
								  ]
								}
								Transform {
								  translation 0 -0.014 -0.012
								  children [
								    USE LIFTER_WASHER
								  ]
								}								
								   
							  ] # LIFTER_SHAPE Group Children
							} # LIFTER_SHAPE Group
							 
#							DEF CALIBRATION_RIG Group {
# 							  children [
# 							    Transform {
# 							      translation 0 -.0125 -0.0135
# 							      children [
# 							        DEF CALIBRATION_TAB Group {
# 							          children [
# 							            Shape {
# 							              geometry Box {
# 							                size .003 .003 .003
# 							              }
# 							            }
# 							            Transform {
# 							              translation -.0015 0 0
# 							              children [
# 							                Shape {
# 							                  geometry Box {
# 							                    size .0002 .0029 .0029
# 							                  }
# 							                  appearance Appearance {
#                						            texture ImageTexture {
# 					                              url "textures/calibrationDot.png"
#                 						        }
#                 						      }
#                 						    }
#                 						  ] # Transform children
#                 						} # Transform
#                 					  ] # CALIBRATION_TAB Group Children
#               						} # CALIBRATION_TAB Group   
# 							      ] # Transform Children
# 							    } # Transform
# 							    Transform {
# 							      translation 0 .0125 -0.0135
# 							      children [
# 							        USE CALIBRATION_TAB
# 							      ]
# 							    }
# 							    Transform {
# 							      translation 0 .0125 0.0035
# 							      children [
# 							        USE CALIBRATION_TAB
# 							      ]
# 							    }
# 							    Transform {
# 							      translation 0 -.0125 0.0035
# 							      children [
# 							        USE CALIBRATION_TAB
# 							      ]
# 							    }
# 							  ] # CALIBRATION_RIG children
# 							} # CALIBRATION_RIG Group        
							Connector {
							  name "gripperConnector"
							  translation 0.0014 0 -0.006
							  rotation 0 1 0 1.57
							  model "magnetic"
							  distanceTolerance 0.003
							  type "active"
							  isLocked FALSE
							  autoLock FALSE
							}

						  ] # SmallFingerGripper Children

						  %{ if not fields.vizMode then }%
						  boundingObject USE LIFTER_SHAPE
						  physics Physics {
						    density 100
						  }
						  %{ end }%
						}  # SmallFingerGripper Solid
					  } # Hinge Joint
					] # Transform children
				  } # Transform
				
				  DEF LEFT_LIFT_ARM Transform {
					translation 0 0.02175 0
					children [
					  DEF LIFT_ARM_SHAPE Shape {
						geometry IndexedFaceSet {
						  coord Coordinate {
							point [
							  0 0.002 -0.0025
							  0 0.002 0.0025
							  0.043 0.002 0.0025
							  0.0626 0.002 -0.0108
							  0.0626 0.002 -0.0158
							  0.043 0.002 -0.0025
							  0 -0.002 -0.0025
							  0 -0.002 0.0025
							  0.043 -0.002 0.0025
							  0.0626 -0.002 -0.0102
							  0.0626 -0.002 -0.0152
							  0.043 -0.002 -0.0025
							]
						  }
						  coordIndex [
							0, 1, 2, -1, 0, 2, 5, -1, 2, 3
							4, -1, 2, 4, 5, -1, 8, 7, 6, -1
							11, 8, 6, -1, 10, 9, 8, -1, 11, 10
							8, -1, 1, 7, 8, -1, 1, 8, 2, -1
							2, 8, 9, -1, 2, 9, 3, -1, 3, 9
							10, -1, 3, 10, 4, -1, 0, 6, 7, -1
							0, 7, 1, -1, 11, 6, 0, -1, 11, 0
							5, -1, 10, 11, 5, -1, 10, 5, 4, -1
						  ]
						  creaseAngle 12
						}
						appearance Appearance {
						  material Material {
						    diffuseColor IS bodyColor
					  	  }
					    }
					  } # DEF LIFT_ARM_SHIFT
					  
					  Transform {
						translation 0.0626 -0.002 -0.012
						children [
						  Shape {
							geometry Cylinder {
							  height 0.012
							  radius 0.0025
							}
							appearance Appearance {
							  material Material {
							    diffuseColor IS bodyColor
							  }
						    }
						  }
						]
					  }
					]
				  } # LEFT_LIFT_ARM Transform
			  
				  DEF RIGHT_LIFT_ARM Transform {
					translation 0 -0.02175 0
					children [
					  USE LIFT_ARM_SHAPE
					  Transform {
						translation 0.0626 0.002 -0.012
						children [
						  Shape {
							geometry Cylinder {
							  height 0.012
							  radius 0.0025
							}
							appearance Appearance {
							  material Material {
							    diffuseColor IS bodyColor
							  }
						    }
						  }
						]
					  }
					]
				  } # RIGHT_LIFT_ARM Transform
			  
				] # endPoint Solid children

				%{ if not fields.vizMode then }%
				boundingObject Group {
				  children [

				    # Right arm
				    Transform {
				      translation 0 -0.02175 0
				      children [
				        USE LIFT_ARM_SHAPE
				      ]
				    }

				    # Left arm
				    Transform {
				      translation 0 0.02175 0
				      children [
				        USE LIFT_ARM_SHAPE
				      ]
				    }

				  ]
				}
				physics Physics {
				  density 100
				}
				%{ end }%

			  } # endPoint Transform
			} # HingeJoint
		  ] # LIFT Transform children
		  #physics Physics {
		  #  density 5000
		  #}
		} # Lift Transform
		
      ] # Wheel RadiusTransform Children
    } # Wheel Radius Transform
    
  ] # Supervisor children
} # Supervisor

} # PROTO definition