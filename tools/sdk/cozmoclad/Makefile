.PHONY: copy-clad copy-csharp-clad license sdist wheel dist csharp_clad/cladcsharp.csproj dist-csharp

copy-clad:
	rm -rf dist/*
	rm -rf src/cozmoclad/clad/*
	rm -rf src/cozmoclad/msgbuffers/*
	cp -r ../../../generated/cladPython/clad src/cozmoclad/
	cp -r ../../message-buffers/support/python/msgbuffers src/cozmoclad/
	# Add license header file to each python file
	# skip msgbuffers as it already has the license in the header.
	find src/cozmoclad/clad \
		-name '*.py' \
		-exec bash -c 'cat LICENSE-header-py.txt {} > {}.tmp' ';' \
		-exec mv -f '{}.tmp' '{}' ';'

copy-csharp-clad:
	rm -rf csharp_clad/clad/*
	rsync -r --exclude=*.meta ../../../unity/Cozmo/Assets/Scripts/Generated/clad csharp_clad/
	# Add license header file to each CS file
	find csharp_clad \
		-name '*.cs' \
		-exec bash -c 'cat LICENSE-header-cs.txt {} > {}.tmp' ';' \
		-exec mv -f '{}.tmp' '{}' ';'

license_targets = src/cozmoclad/LICENSE.txt csharp_clad/LICENSE.txt csharp_interface/LICENSE.txt

license: $(license_targets)

$(license_targets): LICENSE.txt
	for fn in $(license_targets); do \
		cp LICENSE.txt $$fn; \
	done

sdist: license
	python3 setup.py sdist

wheel: license
	python3 setup.py bdist_wheel

dist: sdist wheel

csharp_clad/cladcsharp.csproj:
	python3 gencsharp.py

# Currently, the autogenerated clad code does not expose its "version" anywhere.
# This perl regex tells us what version string to inject into our csharp zip file.
# The python code has dealt with this by using a regular expression via setup.py 
# on an __init__.py which exists permanently in cozmo-one, containing a variable
# named __version__.
version = $(shell perl -ne '/__version__ = "([^"]+)/ && print $$1;' src/cozmoclad/__init__.py)

dist-csharp: copy-csharp-clad csharp_clad/cladcsharp.csproj license
	tar -zcvf dist/cozmoclad-$(version)-csharp.tar.gz csharp_clad/ csharp_interface/
