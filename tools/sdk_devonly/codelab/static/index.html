<html>
    <head>
        <title>CodeLab Dev Menu</title>

        <style>
        div.full_screen {
          height: 100%;
          width: 100%;
        }

        div.left_panel {
          float: left;
          height: 100%;
          width: auto;
        }

        div.debug_log {
          width: auto;
          height:800px;
          border:1px solid #000;
          font:14px;
          overflow:scroll;
        }

        </style>
    </head>
    <body>



    <div class="full_screen">
        <div class="left_panel">
            <h1>Code Lab Dev Menu</h1>

            <button id="toggleCameraFeed" onClick="toggleCameraFeed(this)"
                    style="font-size: 14px">Enable Cozmo Camera Feed</button>
            <p />

            <img src="cozmoImage" id="cozmoImageId" onError="onUpdateImageError()"
                 width=0, height=0>
            <p />

            <button id="enableDevConnectionId" onClick="sendGameToGameMessage(this, 'EnableGameToGame', null)"
                    style="font-size: 14px">Enable Dev Connection</button>
            <p />

            <h2>Upload to device cache:</h2>
            <button id="deleteCacheButtonId" onClick="postHttpRequest('DeleteCache', null)"
                    style="font-size: 14px">Delete Cache</button>
            (delete all contents, next upload will upload everything)
            <p></p>

            <button id="uploadCacheButtonId" onClick="postHttpRequest('UploadToCache', null)"
                    style="font-size: 14px">Upload Files To Cache</button>
            (uploads files changed since last upload)
            <p />

            <h2>Set Unity load path:</h2>

            <button id="setAppPathButtonId" onClick="sendGameToGameMessage(this, 'SetAppPath', null)"
                    style="font-size: 14px">Revert To App Data</button>
            (use pre-built data)
            <p />

            <button id="setCachePathButtonId" onClick="sendGameToGameMessage(this, 'SetCachePath', 'cachePathTextId')"
                    style="font-size: 14px">Use Cache Data</button>
            Path:
            <input type="text" name="cachePathTextName" id="cachePathTextId"
                    value="/CodeLabDev/"
                    style="font-size: 14px; width: 250px;">
            <p />

            <h3>Load URL on device (in Unity):</h3>

            <button id="reloadUrlButtonId" onClick="sendGameToGameMessage(this, 'ReloadURL', null)"
                    style="font-size: 14px">Reload Current Page</button>
            (trigger Unity to reload current page, but on the current path)
            <p />

            <button id="reinitWebViewButtonId" onClick="sendGameToGameMessage(this, 'ReInit', null)"
                    style="font-size: 14px">ReInit WebView</button>
            (trigger Unity to re-init WebView + reload - needed for JS changes)
            <p />

            <button id="loadUrlButtonId" onClick="sendGameToGameMessage(this, 'LoadURL', 'loadUrlTextId')"
                    style="font-size: 14px">Load URL</button>
            <input type="text" name="loadUrlTextName" id="loadUrlTextId" value="index.html"
                   style="font-size: 14px; width: 400px;">
            <p />

            <h3>Set Grammar mode:</h3>

            <button id="setHorizontalGrammarModeId" onClick="sendGameToGameMessage(this, 'UseHorizontalGrammar', null)"
                    style="font-size: 14px">Horizontal Grammar Mode</button>
            <p />

            <button id="setVerticalGrammarModeId" onClick="sendGameToGameMessage(this, 'UseVerticalGrammar', null)"
                    style="font-size: 14px">Vertical Grammar Mode</button>
            <p />
            
        </div>
        <div id="DebugInfoId" class="debug_log"></div>
    </div>

    </body>

    <script type="text/javascript">
        function postHttpRequest(url, dataSet)
        {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            if (dataSet != null )
            {
                dataSet = JSON.stringify(dataSet);
            }
            xhr.send(dataSet);
        }

        var _updateDebugInfoInterval = null;
        function updateDebugInfo()
        {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status != 200) {
                        console.log("updateDebugInfo.BadStatus: '" + xhr.status + "' - cancelling update");
                        clearInterval(_updateDebugInfoInterval);
                        _updateDebugInfoInterval = null;
                    } else if (xhr.responseText != "") {
                        var divElement = document.getElementById("DebugInfoId");
                        divElement.innerHTML += xhr.responseText;
                        divElement.scrollTop = divElement.scrollHeight;
                    }
                }
            }

            xhr.open("POST", "GetDebugInfo", true);
            xhr.send( null );
        }
        _updateDebugInfoInterval = setInterval(updateDebugInfo, 250); // repeat every X ms

        function sendGameToGameMessage(button, method_name, textSrcId)
        {
            var param_text = "";
            if (textSrcId != null) {                
                param_text = document.getElementById(textSrcId).value;
            }
            postHttpRequest('CallGameToGame', {method_name, param_text})
        }

        var gCameraInterval = null;
        function onUpdateImageError()
        {
            console.log("Error loading image - cancelling update");
            if (gCameraInterval != null)
            {
                toggleCameraFeed(document.getElementById("toggleCameraFeed"))
            }
        }

        function updateImage()
        {
            // Note: Firefox ignores the no_store and still caches, needs the "?UID" suffix to fool it
            document.getElementById("cozmoImageId").src="cozmoImage?" + (new Date()).getTime();
        }

        function toggleCameraFeed(button)
        {
            if (gCameraInterval == null)
            {
                gCameraInterval = setInterval(updateImage , 90); // repeat every X ms
                var enabled = true;
                postHttpRequest("EnableCameraFeed", {enabled});
                button.firstChild.data = "Disable Cozmo Camera Feed"
                document.getElementById("cozmoImageId").width=480
                document.getElementById("cozmoImageId").height=360
            }
            else
            {
                clearInterval(gCameraInterval);
                gCameraInterval = null;
                var enabled = false;
                postHttpRequest("EnableCameraFeed", {enabled});
                button.firstChild.data = "Enable Cozmo Camera Feed"
                document.getElementById("cozmoImageId").width=0
                document.getElementById("cozmoImageId").height=0
            }
        }

    </script>
</html>
